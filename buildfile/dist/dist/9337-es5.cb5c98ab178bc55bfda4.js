!function(){"use strict";function e(t,n){return(e=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(t,n)}function t(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var i,s=r(e);if(t){var o=r(this).constructor;i=Reflect.construct(s,arguments,o)}else i=s.apply(this,arguments);return n(this,i)}}function n(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function r(e){return(r=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}(self.webpackChunkassc_crs=self.webpackChunkassc_crs||[]).push([[9337],{9572:function(n,r,s){s.r(r),s.d(r,{DwDmcHttpClient:function(){return b},DwDmcHttpErrorHandler:function(){return y},DwDmcModule:function(){return k},DwDmcRepository:function(){return E},DwLoginDmcRepository:function(){return I},DwUploadFileMangementService:function(){return M},DwUploadFileService:function(){return F}});var a,u=s(42746),c=s(52575),l=s(32276),p=s(30469),d=s(99487),f=s(71049),h=s(47372),v=s(47483),g=s(55245),m=s(66800),y=((a=function(){function e(t,n){i(this,e),this.injector=t,this.dwMessageService=n}return o(e,[{key:"handlerError",value:function(e){var t=this.injector.get(l.DwAuthService);this.dwMessageService.error(e.error.message).subscribe(),(401===e.status||406===e.status)&&t.logout()}}]),e}()).\u0275fac=function(e){return new(e||a)(u.\u0275\u0275inject(u.Injector),u.\u0275\u0275inject(c.DwHttpMessageService))},a.\u0275prov=u.\u0275\u0275defineInjectable({factory:function(){return new a(u.\u0275\u0275inject(u.INJECTOR),u.\u0275\u0275inject(c.DwHttpMessageService))},token:a,providedIn:c.DwHttpModule}),a),b=function(){var n=function(n){!function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),n&&e(t,n)}(s,n);var r=t(s);function s(e,t,n,o){var a;return i(this,s),(a=r.call(this,e,o)).dwHttpRequestUrlService=e,a.configService=t,a.dmcHttpError=n,a.dwHttpLoadMaskService=o,a.getApiUrl().subscribe(function(e){a.api=e}),a}return o(s,[{key:"getApiUrl",value:function(){return this.configService.get("dmcUrl")}},{key:"defaultHeaders",get:function(){return{}}},{key:"errorHandler",value:function(e){e.error&&e.error.message&&this.dmcHttpError.handlerError(e)}}]),s}(c.DwHttpClient);return n.\u0275fac=function(e){return new(e||n)(u.\u0275\u0275inject(c.DwHttpRequestUrlService),u.\u0275\u0275inject(p.DwSystemConfigService),u.\u0275\u0275inject(y),u.\u0275\u0275inject(c.DwHttpLoadMaskService))},n.\u0275prov=u.\u0275\u0275defineInjectable({factory:function(){return new n(u.\u0275\u0275inject(c.DwHttpRequestUrlService),u.\u0275\u0275inject(p.DwSystemConfigService),u.\u0275\u0275inject(y),u.\u0275\u0275inject(c.DwHttpLoadMaskService))},token:n,providedIn:c.DwHttpModule}),n}(),w=p.systemConfigValue,k=function(){var e=o(function e(){i(this,e)});return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=u.\u0275\u0275defineNgModule({type:e}),e.\u0275inj=u.\u0275\u0275defineInjector({providers:[{provide:p.DW_DMC_USERINFO,useFactory:w,deps:[p.APP_SYSTEM_CONFIG,p.DW_SYSTEM_CONFIG_DMC_USER_INFO_KEY]}],imports:[[g.CommonModule],c.DwHttpModule]}),e}(),I=function(){var e=function(){function e(){i(this,e)}return o(e,[{key:"loginDmc",value:function(){return f.Observable.create(function(e){e.next(null),e.complete()})}}]),e}();return e.\u0275fac=function(t){return new(t||e)},e.\u0275prov=u.\u0275\u0275defineInjectable({factory:function(){return new e},token:e,providedIn:k}),e}(),E=function(){var e=function(){function e(t,n,r,s,o){i(this,e),this.dwDapLoginDmcRepository=t,this.http=n,this.dwHttpClientOptionsService=r,this.dwUserService=s,this.dwDmcUserInfo=o,this.userToken=null}return o(e,[{key:"login",value:function(e){var t=this;return this.userToken?new f.Observable(function(e){e.next(t.userToken),e.complete()}):this.dwDapLoginDmcRepository.loginDmc().pipe((0,h.switchMap)(function(n){if(n)return new f.Observable(function(e){e.next(n),e.complete()});if(!t.dwDmcUserInfo.username||!t.dwDmcUserInfo.password)return new f.Observable(function(e){e.error("\u672a\u914d\u7f6eDMC\u7528\u6236\u540d\u5bc6\u78bc\u6216\u8005\u4e0d\u5b8c\u6574\uff01"),e.complete()});var r=v.SHA256(t.dwDmcUserInfo.password),i=v.SHA256(r),s=v.enc.Base64.stringify(i);return t.http.post("api/dmc/v1/auth/login",{tenantId:t.dwUserService.getUser("tenantId"),username:t.dwDmcUserInfo.username,pwdhash:s},{uiOptions:e}).pipe((0,h.map)(function(e){return e.userToken}))}),(0,h.map)(function(e){return t.userToken=e,e}),(0,h.catchError)(function(e){return t.userToken=null,(0,f.throwError)(e)}))}},{key:"mapEvent",value:function(e){if(e.type===d.HttpEventType.UploadProgress){e.data={},e.status="ongoing";var t=Math.round(100*e.loaded/e.total);e.data.percent=100===t?99:t}else e.type===d.HttpEventType.ResponseHeader||e.type===d.HttpEventType.DownloadProgress||e.type===d.HttpEventType.Response||(e.status="ongoing",e.data={},e.data.percent=0);return e}},{key:"getfilterFn",value:function(e){return function(t){return e!==t.data.percent}}},{key:"uploadEntireFile",value:function(e,t,n,r){var i=this;return this.login().pipe((0,h.switchMap)(function(s){var o=-1;i.http.setThrowawayHeader({"digi-middleware-auth-user":s,"digi-middleware-drive-arg":encodeURI(JSON.stringify(t))});var a={reportProgress:!0,observe:"events"};return a=i.dwHttpClientOptionsService.setLoadMaskCfg(a,!1),i.http.post("api/dmc/v1/buckets/".concat(n,"/files"),r,a).pipe((0,h.map)(function(e){return i.mapEvent(e)}),(0,h.filter)(function(e){if(e.type===d.HttpEventType.UploadProgress){var t=i.getfilterFn(o)(e);return o=t?e.data.percent:o,t}return!0}),(0,h.tap)(function(t){!1===e&&t.type===d.HttpEventType.Response&&(i.userToken=null)}),(0,h.catchError)(function(e){return i.userToken=null,(0,f.throwError)(e)}))}))}},{key:"imageUpload",value:function(e,t,n,r,i){var s=this;return this.login().pipe((0,h.switchMap)(function(o){var a=-1;s.http.setThrowawayHeader({"digi-middleware-auth-user":o,"digi-middleware-drive-arg":encodeURI(JSON.stringify(t))});var u={reportProgress:!0,observe:"events",params:new d.HttpParams({fromObject:i})};return u=s.dwHttpClientOptionsService.setLoadMaskCfg(u,!1),s.http.post("api/dmc/v1/buckets/".concat(n,"/images/upload"),r,u).pipe((0,h.map)(function(e){return s.mapEvent(e)}),(0,h.filter)(function(e){if(e.type===d.HttpEventType.UploadProgress){var t=s.getfilterFn(a)(e);return a=t?e.data.percent:a,t}return!0}),(0,h.tap)(function(t){!1===e&&t.type===d.HttpEventType.Response&&(s.userToken=null)}),(0,h.catchError)(function(e){return s.userToken=null,(0,f.throwError)(e)}))}))}},{key:"shrinkImageByFileId",value:function(e,t,n){var r=this;return this.login().pipe((0,h.switchMap)(function(i){r.http.setThrowawayHeader({"digi-middleware-auth-user":i,"Content-Type":"application/octet-stream"});var s=Object.assign({},n);return s.share=n.isShareShrink,delete s.isShareShrink,r.http.get("api/dmc/v1/buckets/".concat(e,"/images/").concat(t),{params:s}).pipe((0,h.tap)(function(){r.userToken=null}),(0,h.catchError)(function(e){return r.userToken=null,(0,f.throwError)(e)}))}))}},{key:"getShrinkImageByFileId",value:function(e,t,n){var r=this;return this.login().pipe((0,h.switchMap)(function(i){return r.http.setThrowawayHeader({"digi-middleware-auth-user":i,"Content-Type":"application/octet-stream"}),r.http.get("api/dmc/v1/buckets/".concat(e,"/images/").concat(t,"/").concat(n)).pipe((0,h.tap)(function(){r.userToken=null}),(0,h.catchError)(function(e){return r.userToken=null,(0,f.throwError)(e)}))}))}},{key:"coverUploadEntireFile",value:function(e,t,n,r){var i=this;return this.login().pipe((0,h.switchMap)(function(s){var o=-1;i.http.setThrowawayHeader({"digi-middleware-auth-user":s});var a={reportProgress:!0,observe:"events"};return a=i.dwHttpClientOptionsService.setLoadMaskCfg(a,!1),i.http.post("api/dmc/v1/buckets/".concat(t,"/files/").concat(n,"/cover"),r,a).pipe((0,h.map)(function(e){return i.mapEvent(e)}),(0,h.filter)(function(e){if(e.type===d.HttpEventType.UploadProgress){var t=i.getfilterFn(o)(e);return o=t?e.data.percent:o,t}return!0}),(0,h.tap)(function(t){!1===e&&t.type===d.HttpEventType.Response&&(i.userToken=null)}),(0,h.catchError)(function(e){return i.userToken=null,(0,f.throwError)(e)}))}))}},{key:"createEmptyFile",value:function(e,t){var n=this;return this.login().pipe((0,h.switchMap)(function(r){return n.http.setThrowawayHeader({"digi-middleware-auth-user":r}),n.http.post("api/dmc/v1/buckets/".concat(e,"/files/segment"),t).pipe((0,h.catchError)(function(e){return n.userToken=null,(0,f.throwError)(e)}))}))}},{key:"pieceUploadFile",value:function(e,t,n,r,i,s,o,a){var u=this;return this.login().pipe((0,h.switchMap)(function(c){var l="api/dmc/v1/buckets/".concat(t,"/files/").concat(n,"/").concat(r,"/").concat(i,"/").concat(s);a&&(l="api/dmc/v1/buckets/".concat(t,"/files/").concat(n,"/").concat(r,"/").concat(i,"/").concat(s,"/cover"));var p=-1;u.http.setThrowawayHeader({"digi-middleware-auth-user":c});var v={reportProgress:!0,observe:"events"};return v=u.dwHttpClientOptionsService.setLoadMaskCfg(v,!1),u.http.post(l,o,v).pipe((0,h.map)(function(e){return u.mapEvent(e)}),(0,h.filter)(function(e){if(e.type===d.HttpEventType.UploadProgress){var t=u.getfilterFn(p)(e);return p=t?e.data.percent:p,t}return!0}),(0,h.tap)(function(t){!1===e&&t.type===d.HttpEventType.Response&&(u.userToken=null)}),(0,h.catchError)(function(e){return u.userToken=null,(0,f.throwError)(e)}))}))}},{key:"download",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{loadMaskCfg:{spinning:!1,delay:0,tip:""}};return this.login(r).pipe((0,h.switchMap)(function(i){return n.http.setThrowawayHeader({"digi-middleware-auth-user":i,"Content-Type":"application/octet-stream"}),n.http.get("api/dmc/v1/buckets/".concat(e,"/files/").concat(t),{responseType:"blob",uiOptions:r}).pipe((0,h.tap)(function(){n.userToken=null}),(0,h.catchError)(function(e){return n.userToken=null,(0,f.throwError)(e)}))}))}},{key:"shareToAll",value:function(e,t){var n=this;return this.login().pipe((0,h.switchMap)(function(r){return n.http.setThrowawayHeader({"digi-middleware-auth-user":r}),n.http.post("api/dmc/v1/buckets/".concat(e,"/ShareFiles"),t).pipe((0,h.tap)(function(){n.userToken=null}),(0,h.catchError)(function(e){return n.userToken=null,(0,f.throwError)(e)}))}))}},{key:"batchDelete",value:function(e,t,n){var r=this;return this.login().pipe((0,h.switchMap)(function(i){return r.http.setThrowawayHeader({"digi-middleware-auth-user":i}),r.http.post("api/dmc/v1/buckets/".concat(t,"/files/delete/batch"),{fileIds:e,dirIds:n}).pipe((0,h.tap)(function(){r.userToken=null}),(0,h.catchError)(function(e){return r.userToken=null,(0,f.throwError)(e)}))}))}},{key:"newDirectorys",value:function(e,t,n){var r=this;return this.login().pipe((0,h.switchMap)(function(i){return r.http.setThrowawayHeader({"digi-middleware-auth-user":i}),r.http.post("api/dmc/v1/buckets/".concat(e,"/directorys"),{parentId:t,name:n}).pipe((0,h.tap)(function(){r.userToken=null}),(0,h.catchError)(function(e){return r.userToken=null,(0,f.throwError)(e)}))}))}},{key:"getDirectorys",value:function(e,t){var n=this;return this.login().pipe((0,h.switchMap)(function(r){return n.http.setThrowawayHeader({"digi-middleware-auth-user":r}),n.http.get("api/dmc/v1/buckets/".concat(e,"/directorys/").concat(t,"/list")).pipe((0,h.tap)(function(){n.userToken=null}),(0,h.catchError)(function(e){return n.userToken=null,(0,f.throwError)(e)}))}))}}]),e}();return e.\u0275fac=function(t){return new(t||e)(u.\u0275\u0275inject(I),u.\u0275\u0275inject(b),u.\u0275\u0275inject(c.DwHttpClientOptionsService),u.\u0275\u0275inject(m.DwUserService),u.\u0275\u0275inject(p.DW_DMC_USERINFO))},e.\u0275prov=u.\u0275\u0275defineInjectable({factory:function(){return new e(u.\u0275\u0275inject(I),u.\u0275\u0275inject(b),u.\u0275\u0275inject(c.DwHttpClientOptionsService),u.\u0275\u0275inject(m.DwUserService),u.\u0275\u0275inject(p.DW_DMC_USERINFO))},token:e,providedIn:c.DwHttpModule}),e}(),F=function(){var e=function(){function e(t,n){i(this,e),this.dmcRepository=t,this.dwDmcUserInfo=n,this.SLICESECTION=2611200,this.defaultBucketName="",this.defaultDirId="00000000-0000-0000-0000-000000000000",this.defaultBucketName=this.dwDmcUserInfo.username}return o(e,[{key:"upload",value:function(e,t,n,r){var i=this;t=t||this.defaultBucketName,n=n||this.defaultDirId,r="boolean"==typeof r&&r;var s=new FileReader;return f.Observable.create(function(o){"object"==typeof e?e.size<=i.SLICESECTION?(i.pushFileMessage(o,"ongoing",0),i.entireUpload(s,e,t,n,o,r)):(i.pushFileMessage(o,"ongoing",0),i.newEmptyFile(e,t,n).subscribe(function(a){i.pushFileMessage(o,"ongoing",5),i.sliceUpload(s,e,a.id,t,n,0,i.SLICESECTION,o,r)},function(e){i.pushFileMessage(o,"error",e)})):i.pushFileMessage(o,"error","\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!")})}},{key:"coverUpload",value:function(e,t,n,r,i){var s=this;n=n||this.defaultBucketName,r=r||this.defaultDirId,i="boolean"==typeof i&&i;var o=new FileReader;return f.Observable.create(function(a){"object"==typeof e?t?(s.pushFileMessage(a,"ongoing",0),e.size<=s.SLICESECTION?s.entireCoverUpload(o,e,t,n,a,i):s.sliceUpload(o,e,t,n,r,0,s.SLICESECTION,a,i,!0)):s.pushFileMessage(a,"error","\u6587\u4ef6ID\u4e0d\u80fd\u70ba\u7a7a!"):s.pushFileMessage(a,"error","\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!")})}},{key:"uploadAndShare",value:function(e,t,n){var r=this;t=t||this.defaultBucketName,n=n||this.defaultDirId;var i="";return f.Observable.create(function(s){"object"==typeof e?r.upload(e,t,n,!0).pipe((0,h.filter)(function(e){return e.hasOwnProperty("fileId")&&e.fileId}),(0,h.switchMap)(function(e){return i=e.fileId,r.pushFileMessage(s,"shareToAll",50,i),r.dmcRepository.shareToAll(t,[i])})).subscribe(function(e){r.pushFileMessage(s,"success",100,i,e[0]),s.complete()},function(e){r.pushFileMessage(s,"error",e)}):r.pushFileMessage(s,"error","\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!")})}},{key:"readAsArrayBuffer",value:function(e,t){return f.Observable.create(function(n){e.addEventListener("load",function(){n.next(e.result),n.complete()}),e.readAsArrayBuffer(t)})}},{key:"entireUpload",value:function(e,t,n,r,i,s){var o=this;this.readAsArrayBuffer(e,t).pipe((0,h.switchMap)(function(e){var i={extension:o.getFileExtension(t.name),displayName:t.name,totalSize:t.size,segmentTotalSize:t.size,fileName:t.name,directoryId:r};return o.dmcRepository.uploadEntireFile(s,i,n,e)})).subscribe(function(e){e instanceof d.HttpResponse&&(o.pushFileMessage(i,"success",100,e.body.id),i.complete())},function(e){o.pushFileMessage(i,"error",e)})}},{key:"imageUpload",value:function(e,t,n,r){var i=this,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return f.Observable.create(function(o){var a=new FileReader;i.readAsArrayBuffer(a,e).pipe((0,h.switchMap)(function(o){var a={extension:i.getFileExtension(e.name),displayName:e.name,fileName:e.name,directoryId:n};return i.dmcRepository.imageUpload(s,a,t,o,r)})).subscribe(function(e){e instanceof d.HttpResponse&&(o.next({status:"success",data:100,originUrl:e.body.data.originUrl,shrinkUrl:e.body.data.shrinkUrl,fileId:e.body.data.fileId}),o.complete())},function(e){i.pushFileMessage(o,"error",e)})})}},{key:"entireCoverUpload",value:function(e,t,n,r,i,s){var o=this;this.readAsArrayBuffer(e,t).pipe((0,h.switchMap)(function(e){return o.dmcRepository.coverUploadEntireFile(s,r,n,e)})).subscribe(function(e){e instanceof d.HttpResponse&&(o.pushFileMessage(i,"success",100,e.body.id),i.complete())},function(e){o.pushFileMessage(i,"error",e)})}},{key:"newEmptyFile",value:function(e,t,n){var r=this;return t=t||this.defaultBucketName,n=n||this.defaultDirId,f.Observable.create(function(i){var s={extension:r.getFileExtension(e.name),displayName:e.name,fileName:e.name,directoryId:n};r.dmcRepository.createEmptyFile(t,s).subscribe(function(e){i.next(e),i.complete()},function(e){i.error(e),i.complete()})})}},{key:"sliceUpload",value:function(e,t,n,r,i,s,o,a,u,c){var l=this,p=t.slice(s,o);c=c||!1;var f=!0;this.readAsArrayBuffer(e,p).pipe((0,h.switchMap)(function(e){return o===t.size&&!1===u&&(f=u),l.dmcRepository.pieceUploadFile(f,r,n,s,o-1,t.size,e,c)})).subscribe(function(p){if(p instanceof d.HttpResponse){if(o===t.size)return l.pushFileMessage(a,"success",100,p.body.id),void a.complete();l.pushFileMessage(a,"ongoing",100*o/t.size),l.sliceUpload(e,t,n,r,i,s+l.SLICESECTION,o+l.SLICESECTION>t.size?t.size:o+l.SLICESECTION,a,u,c)}},function(e){l.pushFileMessage(a,"error",e)})}},{key:"download",value:function(e,t,n){var r=this;return n=n||this.defaultBucketName,f.Observable.create(function(i){e&&t?r.dmcRepository.download(n,e).subscribe(function(e){var n=window.document.createElement("a"),s=window.URL.createObjectURL(e);n.href=s,n.download=t,document.body.appendChild(n);var o=document.createEvent("MouseEvents");o.initEvent("click",!1,!1),n.dispatchEvent(o),window.URL.revokeObjectURL(s),document.body.removeChild(n),r.pushFileMessage(i,"success",100),i.complete()},function(e){r.pushFileMessage(i,"error",e)}):r.pushFileMessage(i,"error","\u6587\u4ef6 ID\u8207\u6a94\u540d\u4e0d\u5f97\u70ba\u7a7a")})}},{key:"deleteFile",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return n=n||this.defaultBucketName,f.Observable.create(function(i){0!==t.length?e.dmcRepository.batchDelete(t,n,r).subscribe(function(t){e.pushFileMessage(i,"success","\u5220\u9664\u6210\u529f"),i.complete()},function(t){e.pushFileMessage(i,"error",t)}):e.pushFileMessage(i,"error","\u522a\u9664\u6578\u7d44\u4e0d\u80fd\u70ba\u7a7a!")})}},{key:"getFileExtension",value:function(e){var t=e.lastIndexOf(".");return e.substring(t+1)}},{key:"pushFileMessage",value:function(e,t,n,r,i){var s={status:t,data:n};r&&(s.fileId=r),i&&(s.shareUrl=i),"error"===t?e.error(s):e.next(s)}}]),e}();return e.\u0275fac=function(t){return new(t||e)(u.\u0275\u0275inject(E),u.\u0275\u0275inject(p.DW_DMC_USERINFO))},e.\u0275prov=u.\u0275\u0275defineInjectable({factory:function(){return new e(u.\u0275\u0275inject(E),u.\u0275\u0275inject(p.DW_DMC_USERINFO))},token:e,providedIn:k}),e}(),M=function(){var e=function(){function e(t,n,r){i(this,e),this.zone=t,this.dmcRepository=n,this.dwDmcUserInfo=r,this._activeSilceUplodLimit=2611200,this.SLICESECTION=2611200,this.defaultBucketName="",this.defaultDirId="00000000-0000-0000-0000-000000000000",this.uploadingSubscriptions=[],this.defaultBucketName=this.dwDmcUserInfo.username}return o(e,[{key:"upload",value:function(e,t,n,r){var i=this;t=t||this.defaultBucketName,n=n||this.defaultDirId,r="boolean"==typeof r&&r;var s=new FileReader;return new f.Observable(function(o){e instanceof File?e.size<=i._activeSilceUplodLimit?i.entireUpload(s,e,t,n,o,r):i.newEmptyFile(e,t,n).subscribe(function(a){i.pushFileMessage(o,{status:"ongoing",percent:1}),i.sliceUpload(s,e,a.id,t,n,0,i.SLICESECTION,o,r)},function(e){i.pushFileMessage(o,{status:"error",message:e})}):i.pushFileMessage(o,{status:"error",message:"\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!"})})}},{key:"coverUpload",value:function(e,t,n,r,i){var s=this;n=n||this.defaultBucketName,r=r||this.defaultDirId,i="boolean"==typeof i&&i;var o=new FileReader;return new f.Observable(function(a){e instanceof File?t?e.size<=s._activeSilceUplodLimit?s.entireCoverUpload(o,e,t,n,a,i):s.sliceUpload(o,e,t,n,r,0,s.SLICESECTION,a,i):s.pushFileMessage(a,{status:"error",message:"\u6587\u4ef6ID\u4e0d\u80fd\u70ba\u7a7a!"}):s.pushFileMessage(a,{status:"error",message:"\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!"})})}},{key:"uploadAndShare",value:function(e,t,n){var r=this;t=t||this.defaultBucketName,n=n||this.defaultDirId;var i="";return new f.Observable(function(s){e instanceof File?r.upload(e,t,n,!0).subscribe(function(e){"success"===e.status?(i=e.fileId,r.pushFileMessage(s,{status:"ongoing",percent:99,fileId:e.fileId}),r.dmcRepository.shareToAll(t,[i]).subscribe(function(e){r.pushFileMessage(s,{status:"success",percent:100,fileId:i,shareUrl:e[0]}),s.complete()},function(e){r.pushFileMessage(s,{status:"error",message:e})})):"ongoing"===e.status&&e.percent&&r.pushFileMessage(s,{status:"ongoing",percent:e.percent,fileId:e.fileId})},function(e){r.pushFileMessage(s,e)}):r.pushFileMessage(s,{status:"error",message:"\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!"})})}},{key:"uploadFile",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{shrink:"1",isShareShrink:"1",width:"150"},o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this._activeSilceUplodLimit;return s.shrink=s.shrink?s.shrink:"1",s.isShareShrink=s.isShareShrink?s.isShareShrink:"1",!s.width&&!s.height&&(s.width="150"),r=r||this.defaultBucketName,i=i||this.defaultDirId,this._activeSilceUplodLimit=o>209715200?209715200:this._activeSilceUplodLimit,new f.Observable(function(o){if(e instanceof File){var a=new RegExp("image/(jpg|png|gif|jpeg|bmp)","i");e.type.match(a)?n?t.imageUploadAndShare(e,r,i,s).subscribe(function(e){o.next(e)},function(e){o.error(e)}):t.upload(e,r,i,!0).subscribe(function(e){"success"===e.status?"1"===s.shrink?t.dmcRepository.shrinkImageByFileId(r,e.fileId,s).subscribe(function(n){t.pushFileMessage(o,{status:"success",percent:100,shareUrl:null,shrinkUrl:n.data.shareUrl?n.data.shareUrl:null,shrinkId:n.data.fileId,fileId:e.fileId}),o.complete()},function(e){t.pushFileMessage(o,{status:"error",message:e})}):(t.pushFileMessage(o,{status:"success",percent:100,shareUrl:null,shrinkUrl:null,shrinkId:null,fileId:e.fileId}),o.complete()):t.pushFileMessage(o,e)},function(e){o.error(e)}):n?t.uploadAndShare(e,r,i).subscribe(function(e){"success"===e.status?(t.pushFileMessage(o,{status:"success",percent:100,shareUrl:e.shareUrl,shrinkUrl:null,shrinkId:null,fileId:e.fileId}),o.complete()):o.next(e)},function(e){o.error(e)}):t.upload(e,r,i,!0).subscribe(function(e){"success"===e.status?(t.pushFileMessage(o,{status:"success",percent:100,shareUrl:null,shrinkUrl:null,shrinkId:null,fileId:e.fileId}),o.complete()):t.pushFileMessage(o,e)},function(e){o.error(e)})}else t.pushFileMessage(o,{status:"error",message:"\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!"})})}},{key:"imageUploadAndShare",value:function(e,t,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{shrink:"1",share:"1",width:"150"};return t=t||this.defaultBucketName,n=n||this.defaultDirId,new f.Observable(function(s){e instanceof File?"1"!==i.shrink?r.uploadAndShare(e,t,n).subscribe(function(e){"success"===e.status?(r.pushFileMessage(s,{status:"success",percent:100,shareUrl:e.shareUrl,shrinkUrl:null,shrinkId:null,fileId:e.fileId}),s.complete()):s.next(e)},function(e){s.error(e)}):r.uploadAndShare(e,t,n).subscribe(function(e){"success"===e.status?r.dmcRepository.shrinkImageByFileId(t,e.fileId,i).subscribe(function(t){r.pushFileMessage(s,{status:"success",percent:100,shareUrl:e.shareUrl,shrinkUrl:t.data.shareUrl?t.data.shareUrl:null,shrinkId:t.data.fileId,fileId:e.fileId}),s.complete()},function(e){r.pushFileMessage(s,{status:"error",message:e})}):r.pushFileMessage(s,e)},function(e){r.pushFileMessage(s,e)}):r.pushFileMessage(s,{status:"error",message:"\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!"})})}},{key:"readAsArrayBuffer",value:function(e,t){return new f.Observable(function(n){e.addEventListener("load",function(){n.next(e.result),n.complete()}),e.readAsArrayBuffer(t)})}},{key:"entireUpload",value:function(e,t,n,r,i,s){var o=this,a=this.readAsArrayBuffer(e,t).pipe((0,h.switchMap)(function(e){var i={extension:o.getFileExtension(t.name),displayName:t.name,totalSize:t.size,segmentTotalSize:t.size,fileName:t.name,directoryId:r};return o.dmcRepository.uploadEntireFile(s,i,n,e)})).subscribe(function(e){e instanceof d.HttpResponse?(o.deleteUploadingSubsciption(t.uid),o.pushFileMessage(i,{status:"success",percent:100,fileId:e.body.id}),i.complete()):(e.type===d.HttpEventType.UploadProgress||e.type===d.HttpEventType.Sent)&&o.pushFileMessage(i,{status:"ongoing",percent:e.data.percent})},function(e){o.pushFileMessage(i,{status:"error",message:e})});this.uploadingSubscriptions.push({uid:t.uid,subscription:a})}},{key:"imageUpload",value:function(e,t,n,r){var i=this,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return new f.Observable(function(o){var a=new FileReader,u=i.readAsArrayBuffer(a,e).pipe((0,h.switchMap)(function(o){var a={extension:i.getFileExtension(e.name),displayName:e.name,fileName:e.name,directoryId:n};return i.dmcRepository.imageUpload(s,a,t,o,r)})).subscribe(function(t){t instanceof d.HttpResponse?(i.deleteUploadingSubsciption(e.uid),i.pushFileMessage(o,{status:"success",percent:100,shareUrl:t.body.data.originUrl,shrinkUrl:t.body.data.shrinkUrl,shrinkId:t.body.data.shrinkId,fileId:t.body.data.fileId}),o.complete()):(t.type===d.HttpEventType.UploadProgress||t.type===d.HttpEventType.Sent)&&i.pushFileMessage(o,{status:"ongoing",percent:t.data.percent})},function(e){i.pushFileMessage(o,{status:"error",message:e})});i.uploadingSubscriptions.push({uid:e.uid,subscription:u})})}},{key:"entireCoverUpload",value:function(e,t,n,r,i,s){var o=this,a=this.readAsArrayBuffer(e,t).pipe((0,h.switchMap)(function(e){return o.dmcRepository.coverUploadEntireFile(s,r,n,e)})).subscribe(function(e){e instanceof d.HttpResponse?(o.deleteUploadingSubsciption(t.uid),o.pushFileMessage(i,{status:"success",percent:100,fileId:e.body.id}),i.complete()):(e.type===d.HttpEventType.UploadProgress||e.type===d.HttpEventType.Sent)&&o.pushFileMessage(i,{status:"ongoing",percent:e.data.percent})},function(e){o.pushFileMessage(i,{status:"error",message:e})});this.uploadingSubscriptions.push({uid:t.uid,subscription:a})}},{key:"newEmptyFile",value:function(e,t,n){var r=this;return t=t||this.defaultBucketName,n=n||this.defaultDirId,new f.Observable(function(i){var s={extension:r.getFileExtension(e.name),displayName:e.name,fileName:e.name,directoryId:n};r.dmcRepository.createEmptyFile(t,s).subscribe(function(e){i.next(e),i.complete()},function(e){i.error(e),i.complete()})})}},{key:"sliceUpload",value:function(e,t,n,r,i,s,o,a,u,c){var l=this,p=t.slice(s,o);c=c||!1;var f=!0,v=-1,g=this.readAsArrayBuffer(e,p).pipe((0,h.switchMap)(function(e){return o===t.size&&!1===u&&(f=u),l.dmcRepository.pieceUploadFile(f,r,n,s,o-1,t.size,e,c)})).subscribe(function(p){if(p instanceof d.HttpResponse){if(l.deleteUploadingSubsciption(t.uid),o===t.size)return l.pushFileMessage(a,{status:"success",percent:100,fileId:n}),void a.complete();l.sliceUpload(e,t,n,r,i,s+l.SLICESECTION,o+l.SLICESECTION>t.size?t.size:o+l.SLICESECTION,a,u,c)}else if((p.type===d.HttpEventType.UploadProgress||p.type===d.HttpEventType.Sent)&&p.type===d.HttpEventType.UploadProgress){var f=Math.round(100*(p.loaded+s)/t.size);v!==f&&(l.pushFileMessage(a,{status:"ongoing",percent:100===f?99:f}),v=f)}},function(e){l.pushFileMessage(a,{status:"error",message:e})});this.uploadingSubscriptions.push({uid:t.uid,subscription:g,fileId:n,uplodFrom:s,bucketName:r,dirId:i})}},{key:"download",value:function(e,t,n){var r=this;return n=n||this.defaultBucketName,new f.Observable(function(i){e&&t?r.dmcRepository.download(n,e).subscribe(function(e){var n=window.document.createElement("a"),s=window.URL.createObjectURL(e);n.href=s,n.download=t,document.body.appendChild(n);var o=document.createEvent("MouseEvents");o.initEvent("click",!1,!1),n.dispatchEvent(o),window.URL.revokeObjectURL(s),document.body.removeChild(n),r.pushFileMessage(i,{status:"success",percent:100}),i.complete()},function(e){r.pushFileMessage(i,{status:"error",message:e})}):r.pushFileMessage(i,{status:"error",message:"\u6587\u4ef6 ID\u8207\u6a94\u540d\u4e0d\u5f97\u70ba\u7a7a"})})}},{key:"deleteFile",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0;return n=n||this.defaultBucketName,new f.Observable(function(r){0!==t.length?e.dmcRepository.batchDelete(t,n,[]).subscribe(function(t){e.pushFileMessage(r,{status:"success",message:"\u5220\u9664\u6210\u529f"}),r.complete()},function(t){e.pushFileMessage(r,{status:"error",message:t})}):e.pushFileMessage(r,{status:"error",message:"\u522a\u9664\u6578\u7d44\u4e0d\u80fd\u70ba\u7a7a!"})})}},{key:"getFileExtension",value:function(e){var t=e.lastIndexOf(".");return e.substring(t+1)}},{key:"pushFileMessage",value:function(e,t){var n=t;"error"===t.status?e.error(n):e.next(n)}},{key:"newDirectorys",value:function(e,t,n){return this.dmcRepository.newDirectorys(n=n||this.defaultBucketName,t=t||this.defaultDirId,e)}},{key:"getDirectorys",value:function(e,t){return this.dmcRepository.getDirectorys(t=t||this.defaultBucketName,e=e||this.defaultDirId)}},{key:"cancelUploading",value:function(e){var t=this;this.uploadingSubscriptions.forEach(function(n){n.uid===e&&n.subscription&&(n.subscription.unsubscribe(),n.hasOwnProperty("fileId")&&t.zone.runOutsideAngular(function(){var e;e=n,setTimeout(function(){t.deleteFile([e.fileId],e.bucketName).subscribe()},0)}))})}},{key:"deleteUploadingSubsciption",value:function(e){var t=this.uploadingSubscriptions.findIndex(function(t){return t.uid===e});this.uploadingSubscriptions.splice(t,1)}},{key:"getDataUrlAndBlobByFileId",value:function(e,t,n){return this.dmcRepository.download(t=t||this.defaultBucketName,e,n).pipe((0,h.switchMap)(function(e){return new f.Observable(function(t){var n=new FileReader;n.onload=function(n){t.next({dataUrl:n.target.result,blob:e}),t.complete()},n.readAsDataURL(e)})}))}}]),e}();return e.\u0275fac=function(t){return new(t||e)(u.\u0275\u0275inject(u.NgZone),u.\u0275\u0275inject(E),u.\u0275\u0275inject(p.DW_DMC_USERINFO))},e.\u0275prov=u.\u0275\u0275defineInjectable({factory:function(){return new e(u.\u0275\u0275inject(u.NgZone),u.\u0275\u0275inject(E),u.\u0275\u0275inject(p.DW_DMC_USERINFO))},token:e,providedIn:k}),e}()}}])}();