!function(){"use strict";function e(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),n&&t(e,n)}function t(e,n){return(t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,n)}function n(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var n,o=i(e);if(t){var a=i(this).constructor;n=Reflect.construct(o,arguments,a)}else n=o.apply(this,arguments);return r(this,n)}}function r(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}(self.webpackChunkassc_crs=self.webpackChunkassc_crs||[]).push([[5622,8545],{75622:function(t,r,i){i.r(r),i.d(r,{DwIamAuthService:function(){return j},DwIamHttpClient:function(){return b},DwIamHttpErrorHandler:function(){return S},DwIamModule:function(){return O},DwIamRepository:function(){return T},DwIamTenantService:function(){return D},DwIamUserService:function(){return I},DwSsoService:function(){return P},DwSsoTokenRefreshService:function(){return U},SsoUtility:function(){return A}});var a,u=i(42746),s=i(87974),p=i(71049),f=i(47372),l=i(83522),d=i(47483),v=i(52575),h=i(30469),y=i(32276),w=i(32245),g=i(66800),m=i(12146),k=i(55245),S=((a=function(){function e(t){o(this,e),this.dwHttpErrorHandlerService=t}return c(e,[{key:"handlerError",value:function(e){this.dwHttpErrorHandlerService.handle(e)}}]),e}()).\u0275fac=function(e){return new(e||a)(u.\u0275\u0275inject(v.DwHttpErrorHandlerService))},a.\u0275prov=u.\u0275\u0275defineInjectable({factory:function(){return new a(u.\u0275\u0275inject(v.DwHttpErrorHandlerService))},token:a,providedIn:v.DwHttpModule}),a),b=function(){var t=function(t){e(i,t);var r=n(i);function i(e,t,n,a,c,u,s){var p;return o(this,i),(p=r.call(this,e,s)).dwHttpRequestUrlService=e,p.configService=t,p.authToken=n,p.iamHttpError=a,p.dwAppAuthToken=c,p.dwLanguageService=u,p.dwHttpLoadMaskService=s,p.getApiUrl().subscribe(function(e){p.api=e}),p}return c(i,[{key:"getApiUrl",value:function(){return this.configService.get("iamUrl")}},{key:"defaultHeaders",get:function(){var e={"digi-middleware-auth-app":this.dwAppAuthToken,"digi-middleware-auth-user":this.authToken.token?this.authToken.token:"","Client-Agent":"webplatform/"+h.DW_SYSTEM_CONFIG.dwVersion},t=this.dwLanguageService.currentLanguage;return t&&(t=t.replace("_","-"),e["Accept-Language"]=t),e}},{key:"errorHandler",value:function(e){this.iamHttpError.handlerError(e)}}]),i}(v.DwHttpClient);return t.\u0275fac=function(e){return new(e||t)(u.\u0275\u0275inject(v.DwHttpRequestUrlService),u.\u0275\u0275inject(h.DwSystemConfigService),u.\u0275\u0275inject(y.DW_AUTH_TOKEN),u.\u0275\u0275inject(S,2),u.\u0275\u0275inject(h.DW_APP_AUTH_TOKEN),u.\u0275\u0275inject(w.DwLanguageService),u.\u0275\u0275inject(v.DwHttpLoadMaskService))},t.\u0275prov=u.\u0275\u0275defineInjectable({factory:function(){return new t(u.\u0275\u0275inject(v.DwHttpRequestUrlService),u.\u0275\u0275inject(h.DwSystemConfigService),u.\u0275\u0275inject(y.DW_AUTH_TOKEN),u.\u0275\u0275inject(S,2),u.\u0275\u0275inject(h.DW_APP_AUTH_TOKEN),u.\u0275\u0275inject(w.DwLanguageService),u.\u0275\u0275inject(v.DwHttpLoadMaskService))},token:t,providedIn:v.DwHttpModule}),t}(),T=function(){var e=function(){function e(t,n,r){o(this,e),this.http=t,this.dwAppId=n,this.dwHttpClientOptionsService=r}return c(e,[{key:"login",value:function(e){return this.http.post("api/iam/v2/identity/login",e)}},{key:"internalLogin",value:function(e){return this.http.post("api/iam/v2/identity/internal/login",e)}},{key:"logout",value:function(){return this.http.post("api/iam/v2/identity/logout",{})}},{key:"getTenantList",value:function(){return this.dwAppId?this.http.post("api/iam/v2/tenant?appId=".concat(this.dwAppId),{}).pipe((0,f.map)(function(e){return e.map(function(e){return Object.assign(e,{tenantSid:e.sid,tenantId:e.id,tenantName:e.name})})})):p.Observable.create(function(e){e.next([]),e.complete(),console.log("tenants error")})}},{key:"getUserInfo",value:function(e){return this.http.post("api/iam/v2/user/withtenant",e?{id:e}:{}).pipe((0,f.map)(function(e){return Object.assign(e,{userId:e.id,userName:e.name})}))}},{key:"analyzeToken",value:function(){return this.http.post("api/iam/v2/identity/token/analyze",{}).pipe((0,f.map)(function(e){return Object.assign(e,{userId:e.id,userName:e.name})}))}},{key:"tokenRefreshApp",value:function(){return this.http.post("api/iam/v2/identity/token/refresh/app",{})}},{key:"tokenRefreshTenant",value:function(e){return this.http.post("api/iam/v2/identity/token/refresh/tenant",{tenantSid:e}).pipe((0,f.map)(function(e){return Object.assign(e,{token:e.user_token})}))}},{key:"updatePassword",value:function(e){return this.http.post("api/iam/v2/user/password/update",{account:e.account,password:e.password,verificationCode:e.verificationCode})}},{key:"verifyEmailExist",value:function(e){var t=this.dwHttpClientOptionsService.setLoadMaskCfg({},!1);return this.http.post("api/iam/v2/user/email/exist",e,t)}},{key:"verifyMobilephoneExist",value:function(e){var t=this.dwHttpClientOptionsService.setLoadMaskCfg({},!1);return this.http.post("api/iam/v2/user/mobilephone/exist",e,t)}},{key:"getUserSalt",value:function(e){return this.http.post("api/iam/v2/user/salt",{id:e})}},{key:"permissionUserActions",value:function(){return this.http.post("api/iam/v2/permission/user/actions",{id:this.dwAppId})}},{key:"userPasswordUpdate",value:function(e){return this.http.post("api/iam/v2/user/password/update",e)}},{key:"userPasswordUpdateForce",value:function(e){return this.http.post("api/iam/v2/user/update/password/force",e)}},{key:"userUpdatePasswordWithOldPassword",value:function(e){return this.http.post("api/iam/v2/user/update/password",e)}},{key:"getUserBasicInfo",value:function(e){return this.http.post("api/iam/v2/user",{id:e})}},{key:"updateUserBasicInfo",value:function(e){return this.http.post("api/iam/v2/user/update",e)}},{key:"updateUserHeadimageUrl",value:function(e,t){return this.http.post("api/iam/v2/user/update/headimageurl",{sid:t,headImageUrl:e})}},{key:"getIdentityPublickey",value:function(){return this.http.get("api/iam/v2/identity/publickey")}},{key:"getIdentityAeskey",value:function(e){return this.http.post("api/iam/v2/identity/aeskey",{clientEncryptPublicKey:e})}},{key:"agreeagreementUpdate",value:function(e,t){var n=this.http.newHttpHeaders();return n=n.set("digi-middleware-auth-user",e),this.http.post("api/iam/v2/user/agreeagreement/update",{agreeAgreement:t},{headers:n})}}]),e}();return e.\u0275fac=function(t){return new(t||e)(u.\u0275\u0275inject(b),u.\u0275\u0275inject(h.DW_APP_ID),u.\u0275\u0275inject(v.DwHttpClientOptionsService))},e.\u0275prov=u.\u0275\u0275defineInjectable({factory:function(){return new e(u.\u0275\u0275inject(b),u.\u0275\u0275inject(h.DW_APP_ID),u.\u0275\u0275inject(v.DwHttpClientOptionsService))},token:e,providedIn:v.DwHttpModule}),e}(),j=function(){var t=function(t){e(i,t);var r=n(i);function i(e,t,n,a,c,u,s,p,f,l){var d;return o(this,i),(d=r.call(this,e,t,u,s,p)).router=e,d.userService=t,d.iamRepository=n,d.configService=a,d.translateService=c,d.authToken=u,d.defaultLogin=s,d.dwTenantService=p,d.dwDeclarationService=f,d.dwChangePasswordInfoService=l,d.configService.get("multiTenant").subscribe(function(e){d.isServiceCloud=e,d.dwMultiTenant=e}),d.dwTenantService.isTokenValid$.subscribe(function(e){!1===e&&d.iamLogout()}),d.dwTenantService.tenantInfoRefresh$.subscribe(function(e){d.setLogined(e)}),d.isLoggedIn$.subscribe(function(e){!1===e&&(d.dwTenantService.setTenantList([]),d.dwTenantService.setTokenValid(!1))}),d}return c(i,[{key:"login",value:function(e){var t=this,n={success:!0,description:""};return new p.Observable(function(r){t.getLoginApiBody(e).pipe((0,f.concatMap)(function(n){return e.loginType===m.DwLoginTypeEnum.INTERNAL?t.iamRepository.internalLogin(n):t.iamRepository.login(n)}),(0,f.switchMap)(function(e){return t.shouldAgreeDeclaration(e)})).subscribe(function(e){if(!t.dwMultiTenant)return t.setLogined(e),t.dwTenantService.setTokenValid(!0),r.next(n),void r.complete();t.setAuthToken(e),t.shouldChangeDefaultPassword().pipe((0,f.switchMap)(function(e){if(!1===e)return t.dwTenantService.getTenants();t.logout(!1),location.reload()})).subscribe(function(e){if(0===e.length)return n.description=t.translateService.instant("dw-login-failure-noTenant"),r.next(t.setLoginFail(n)),void r.complete();1!==e.length?(n.success=null,r.next(n),r.complete()):t.dwTenantService.tokenRefreshTenant(e[0].tenantSid).subscribe(function(e){r.next(n),r.complete()},function(e){r.error(e),r.complete()})},function(e){r.error(e),r.complete()})},function(e){r.error(e),r.complete()})})}},{key:"shouldAgreeDeclaration",value:function(e){var t=this;return e.hasOwnProperty("agreeAgreement")&&!1===e.agreeAgreement?new p.Observable(function(n){t.dwDeclarationService.shouldAgree(e).subscribe(function(r){!0===r?(n.next(e),n.complete()):(n.error({error:{errorMessage:t.translateService.instant("dw-declaration-not-active-info")}}),n.complete())})}):(0,p.of)(e)}},{key:"shouldChangeDefaultPassword",value:function(){var e=this;return new p.Observable(function(t){!1===e.userService.getUser("changed")?e.dwChangePasswordInfoService.shouldChanedPassword().subscribe(function(e){t.next(!0),t.complete()}):(t.next(!1),t.complete())})}},{key:"setLoginFail",value:function(e){return e.success=!1,e.description=e.description?e.description:this.translateService.instant("dw-login-failure"),e}},{key:"getLoginApiBody",value:function(e){return(0,p.forkJoin)([this.getUserSalt(e),this.getClientEncrypt(e)]).pipe((0,f.map)(function(t){var n={tenantId:e.tenantId,userId:e.userId,identityType:e.identityType};return Object.assign(n,{passwordHash:t[1].passwordHash,clientEncryptPublicKey:t[1].clientEncryptPublicKey}),t[0].salt&&Object.assign(n,{passwordHash1:d.MD5(e.password+t[0].salt).toString()}),n}))}},{key:"getUserSalt",value:function(e){return this.isServiceCloud?this.iamRepository.getUserSalt(e.userId):(0,p.of)({})}},{key:"getClientEncrypt",value:function(e){return this.getAESKey().pipe((0,f.map)(function(t){var n=d.enc.Utf8.parse(t.aeskey),r=d.enc.Utf8.parse("ghUb#er57HBh(u%g");return{passwordHash:d.AES.encrypt(e.password,n,{iv:r,mode:d.mode.CBC,padding:d.pad.Pkcs7}).toString(),clientEncryptPublicKey:t.clientEncryptPublicKey}}))}},{key:"getAESKey",value:function(){var e=this;return this.iamRepository.getIdentityPublickey().pipe((0,f.switchMap)(function(t){var n=new JSEncrypt({default_key_size:1024}),r=n.getPublicKey();r=(r=r.replace("-----BEGIN PUBLIC KEY-----\n","")).replace("\n-----END PUBLIC KEY-----","");var i=new JSEncrypt({default_key_size:2048});i.setPublicKey(t.publicKey);var o=i.encrypt(r);return e.iamRepository.getIdentityAeskey(o).pipe((0,f.map)(function(e){return{aeskey:n.decrypt(e.encryptAesKey),clientEncryptPublicKey:o}}))}))}},{key:"iamLogout",value:function(){!this.authToken.token||this.iamRepository.logout().subscribe()}}]),i}(y.DwAuthService);return t.\u0275fac=function(e){return new(e||t)(u.\u0275\u0275inject(s.Router),u.\u0275\u0275inject(g.DwUserService),u.\u0275\u0275inject(T),u.\u0275\u0275inject(h.DwSystemConfigService),u.\u0275\u0275inject(l.TranslateService),u.\u0275\u0275inject(y.DW_AUTH_TOKEN),u.\u0275\u0275inject(h.LONIG_DEFAULT),u.\u0275\u0275inject(g.DwTenantService),u.\u0275\u0275inject(m.DwDeclarationService),u.\u0275\u0275inject(m.DwChangePasswordInfoService))},t.\u0275prov=u.\u0275\u0275defineInjectable({token:t,factory:t.\u0275fac}),t}(),D=function(){var t=function(t){e(i,t);var r=n(i);function i(e,t,n){var a;return o(this,i),(a=r.call(this,e)).userService=e,a.iamRepository=t,a.authToken=n,a._authService=null,a.tokenValidSubject=new p.BehaviorSubject(a.tokenValid),a.tenantSubject=new p.BehaviorSubject(a.currTenantList),a}return c(i,[{key:"getTenants",value:function(){var e=this;return this.iamRepository.getTenantList().pipe((0,f.tap)(function(t){e.setTenantList(t)}))}},{key:"tokenRefreshTenant",value:function(e){var t=this;return this.iamRepository.tokenRefreshTenant(e).pipe((0,f.tap)(function(e){t.authToken.token!==e.token&&t.setTokenValid(!1),t.tenantInfoRefresh$.next(e),t.setTokenValid(!0)}))}}]),i}(g.DwTenantService);return t.\u0275fac=function(e){return new(e||t)(u.\u0275\u0275inject(g.DwUserService),u.\u0275\u0275inject(T),u.\u0275\u0275inject(y.DW_AUTH_TOKEN))},t.\u0275prov=u.\u0275\u0275defineInjectable({token:t,factory:t.\u0275fac}),t}(),I=function(){var t=function(t){e(i,t);var r=n(i);function i(e,t){var n;return o(this,i),(n=r.call(this,e)).userStorage=e,n.iamRepository=t,n}return c(i,[{key:"read",value:function(e){var t=this;return new p.Observable(function(n){t.iamRepository.getUserInfo(e).subscribe(function(e){t.setUserInfo(e),n.next({success:!0,description:"",userInfo:e}),n.complete()},function(e){n.error(e),n.complete()})})}}]),i}(g.DwUserService);return t.\u0275fac=function(e){return new(e||t)(u.\u0275\u0275inject(g.DwUserStorage),u.\u0275\u0275inject(T))},t.\u0275prov=u.\u0275\u0275defineInjectable({token:t,factory:t.\u0275fac}),t}(),U=function(){var e=function(){function e(t,n){o(this,e),this.iamRepository=t,this.dwAppType=n}return c(e,[{key:"tokenRefreshApp",value:function(e){return"SharedApp"===this.dwAppType?p.Observable.create(function(t){t.next({user_token:e}),t.complete()}):this.iamRepository.tokenRefreshApp()}}]),e}();return e.\u0275fac=function(t){return new(t||e)(u.\u0275\u0275inject(T),u.\u0275\u0275inject(h.DW_APP_TYPE))},e.\u0275prov=u.\u0275\u0275defineInjectable({token:e,factory:e.\u0275fac}),e}(),A=function(){function e(){o(this,e)}return c(e,null,[{key:"getSsoUrl",value:function(t,n,r){var i=t.split("?");"/"!==i[0].substr(-1)&&(i[0]+="/");var o=new URL(t),a=e.getJsonFromUrl(o);r||(r={});var c=Object.assign({},{userToken:n},a,r),u=Object.keys(c).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(c[e])}).join("&");return i[0]+"sso-login?"+u}},{key:"getJsonFromUrl",value:function(e){var t=e.search.substr(1),n={};return t&&t.split("&").forEach(function(e){var t=e.split("=");n[t[0]]=decodeURIComponent(t[1])}),n}}]),e}(),P=function(){var e=function(){function e(t,n,r,i,a,c,u){var s=this;o(this,e),this.dwSsoTokenRefreshService=t,this.userService=n,this.authService=r,this.configService=i,this.dwTenantService=a,this.iamRepository=c,this.dwChangePasswordInfoService=u,this.configService.get("multiTenant").subscribe(function(e){return s.dwMultiTenant=e})}return c(e,[{key:"redirectUrl",value:function(e,t,n){var r=A.getSsoUrl(e,this.userService.getUser("token"),n);!0===t?window.open(r):document.location.href=r}},{key:"ssoLogin",value:function(e){var t=this;return new p.Observable(function(n){var r=e.get("userToken")||"";r?(t.authService.setAuthToken({token:r}),t.dwSsoTokenRefreshService.tokenRefreshApp(r).pipe((0,f.switchMap)(function(e){return r=e.user_token,t.authService.setAuthToken({token:r}),t.iamRepository.getUserInfo()})).subscribe(function(e){e.hasOwnProperty("userType")||(e.userType=e.type),t.authService.setAuthToken(e),t.shouldChangeDefaultPassword().subscribe(function(r){t.authService.setLogined(e),t.dwTenantService.setTokenValid(!0),t.dwMultiTenant&&t.dwTenantService.getTenants().subscribe(),n.next(!0),n.complete()})},function(e){n.error(e),n.complete()})):(n.next(!1),n.complete())})}},{key:"shouldChangeDefaultPassword",value:function(){var e=this;return new p.Observable(function(t){!1===e.userService.getUser("changed")?e.dwChangePasswordInfoService.shouldChanedPassword().subscribe(function(e){t.next(!0),t.complete()}):(t.next(!1),t.complete())})}}]),e}();return e.\u0275fac=function(t){return new(t||e)(u.\u0275\u0275inject(U),u.\u0275\u0275inject(g.DwUserService),u.\u0275\u0275inject(y.DwAuthService),u.\u0275\u0275inject(h.DwSystemConfigService),u.\u0275\u0275inject(g.DwTenantService),u.\u0275\u0275inject(T),u.\u0275\u0275inject(m.DwChangePasswordInfoService))},e.\u0275prov=u.\u0275\u0275defineInjectable({token:e,factory:e.\u0275fac}),e}(),O=function(){var e=c(function e(){o(this,e)});return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=u.\u0275\u0275defineNgModule({type:e}),e.\u0275inj=u.\u0275\u0275defineInjector({providers:[{provide:y.DwAuthService,useClass:j},{provide:g.DwTenantService,useClass:D},{provide:g.DwUserService,useClass:I},U,P,{provide:h.DW_SSO_LOGIN,useClass:P,multi:!0}],imports:[[k.CommonModule],v.DwHttpModule]}),e}()}}])}();