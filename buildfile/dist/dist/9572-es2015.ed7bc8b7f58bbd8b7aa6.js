"use strict";(self.webpackChunkassc_crs=self.webpackChunkassc_crs||[]).push([[9572,9337],{9572:function(e,t,s){s.r(t),s.d(t,{DwDmcHttpClient:function(){return g},DwDmcHttpErrorHandler:function(){return d},DwDmcModule:function(){return f},DwDmcRepository:function(){return b},DwLoginDmcRepository:function(){return w},DwUploadFileMangementService:function(){return v},DwUploadFileService:function(){return y}});var i=s(42746),r=s(52575),n=s(32276),a=s(30469),o=s(99487),l=s(71049),p=s(47372),c=s(47483),u=s(55245),h=s(66800);let d=(()=>{class e{constructor(e,t){this.injector=e,this.dwMessageService=t}handlerError(e){const t=this.injector.get(n.DwAuthService);this.dwMessageService.error(e.error.message).subscribe(),(401===e.status||406===e.status)&&t.logout()}}return e.\u0275fac=function(t){return new(t||e)(i.\u0275\u0275inject(i.Injector),i.\u0275\u0275inject(r.DwHttpMessageService))},e.\u0275prov=i.\u0275\u0275defineInjectable({factory:function(){return new e(i.\u0275\u0275inject(i.INJECTOR),i.\u0275\u0275inject(r.DwHttpMessageService))},token:e,providedIn:r.DwHttpModule}),e})(),g=(()=>{class e extends r.DwHttpClient{constructor(e,t,s,i){super(e,i),this.dwHttpRequestUrlService=e,this.configService=t,this.dmcHttpError=s,this.dwHttpLoadMaskService=i,this.getApiUrl().subscribe(e=>{this.api=e})}getApiUrl(){return this.configService.get("dmcUrl")}get defaultHeaders(){return{}}errorHandler(e){e.error&&e.error.message&&this.dmcHttpError.handlerError(e)}}return e.\u0275fac=function(t){return new(t||e)(i.\u0275\u0275inject(r.DwHttpRequestUrlService),i.\u0275\u0275inject(a.DwSystemConfigService),i.\u0275\u0275inject(d),i.\u0275\u0275inject(r.DwHttpLoadMaskService))},e.\u0275prov=i.\u0275\u0275defineInjectable({factory:function(){return new e(i.\u0275\u0275inject(r.DwHttpRequestUrlService),i.\u0275\u0275inject(a.DwSystemConfigService),i.\u0275\u0275inject(d),i.\u0275\u0275inject(r.DwHttpLoadMaskService))},token:e,providedIn:r.DwHttpModule}),e})();const m=a.systemConfigValue;let f=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=i.\u0275\u0275defineNgModule({type:e}),e.\u0275inj=i.\u0275\u0275defineInjector({providers:[{provide:a.DW_DMC_USERINFO,useFactory:m,deps:[a.APP_SYSTEM_CONFIG,a.DW_SYSTEM_CONFIG_DMC_USER_INFO_KEY]}],imports:[[u.CommonModule],r.DwHttpModule]}),e})(),w=(()=>{class e{constructor(){}loginDmc(){return l.Observable.create(e=>{e.next(null),e.complete()})}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275prov=i.\u0275\u0275defineInjectable({factory:function(){return new e},token:e,providedIn:f}),e})(),b=(()=>{class e{constructor(e,t,s,i,r){this.dwDapLoginDmcRepository=e,this.http=t,this.dwHttpClientOptionsService=s,this.dwUserService=i,this.dwDmcUserInfo=r,this.userToken=null}login(e){return this.userToken?new l.Observable(e=>{e.next(this.userToken),e.complete()}):this.dwDapLoginDmcRepository.loginDmc().pipe((0,p.switchMap)(t=>{if(t)return new l.Observable(e=>{e.next(t),e.complete()});if(!this.dwDmcUserInfo.username||!this.dwDmcUserInfo.password)return new l.Observable(e=>{e.error("\u672a\u914d\u7f6eDMC\u7528\u6236\u540d\u5bc6\u78bc\u6216\u8005\u4e0d\u5b8c\u6574\uff01"),e.complete()});{const t=c.SHA256(this.dwDmcUserInfo.password),s=c.SHA256(t),i=c.enc.Base64.stringify(s);return this.http.post("api/dmc/v1/auth/login",{tenantId:this.dwUserService.getUser("tenantId"),username:this.dwDmcUserInfo.username,pwdhash:i},{uiOptions:e}).pipe((0,p.map)(e=>e.userToken))}}),(0,p.map)(e=>(this.userToken=e,e)),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e))))}mapEvent(e){if(e.type===o.HttpEventType.UploadProgress){e.data={},e.status="ongoing";const t=Math.round(100*e.loaded/e.total);e.data.percent=100===t?99:t}else e.type===o.HttpEventType.ResponseHeader||e.type===o.HttpEventType.DownloadProgress||e.type===o.HttpEventType.Response||(e.status="ongoing",e.data={},e.data.percent=0);return e}getfilterFn(e){return t=>e!==t.data.percent}uploadEntireFile(e,t,s,i){return this.login().pipe((0,p.switchMap)(r=>{let n=-1;this.http.setThrowawayHeader({"digi-middleware-auth-user":r,"digi-middleware-drive-arg":encodeURI(JSON.stringify(t))});let a={reportProgress:!0,observe:"events"};return a=this.dwHttpClientOptionsService.setLoadMaskCfg(a,!1),this.http.post(`api/dmc/v1/buckets/${s}/files`,i,a).pipe((0,p.map)(e=>this.mapEvent(e)),(0,p.filter)(e=>{if(e.type===o.HttpEventType.UploadProgress){const t=this.getfilterFn(n)(e);return n=t?e.data.percent:n,t}return!0}),(0,p.tap)(t=>{!1===e&&t.type===o.HttpEventType.Response&&(this.userToken=null)}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e))))}))}imageUpload(e,t,s,i,r){return this.login().pipe((0,p.switchMap)(n=>{let a=-1;this.http.setThrowawayHeader({"digi-middleware-auth-user":n,"digi-middleware-drive-arg":encodeURI(JSON.stringify(t))});let c={reportProgress:!0,observe:"events",params:new o.HttpParams({fromObject:r})};return c=this.dwHttpClientOptionsService.setLoadMaskCfg(c,!1),this.http.post(`api/dmc/v1/buckets/${s}/images/upload`,i,c).pipe((0,p.map)(e=>this.mapEvent(e)),(0,p.filter)(e=>{if(e.type===o.HttpEventType.UploadProgress){const t=this.getfilterFn(a)(e);return a=t?e.data.percent:a,t}return!0}),(0,p.tap)(t=>{!1===e&&t.type===o.HttpEventType.Response&&(this.userToken=null)}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e))))}))}shrinkImageByFileId(e,t,s){return this.login().pipe((0,p.switchMap)(i=>{this.http.setThrowawayHeader({"digi-middleware-auth-user":i,"Content-Type":"application/octet-stream"});const r=Object.assign({},s);return r.share=s.isShareShrink,delete r.isShareShrink,this.http.get(`api/dmc/v1/buckets/${e}/images/${t}`,{params:r}).pipe((0,p.tap)(()=>{this.userToken=null}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e))))}))}getShrinkImageByFileId(e,t,s){return this.login().pipe((0,p.switchMap)(i=>(this.http.setThrowawayHeader({"digi-middleware-auth-user":i,"Content-Type":"application/octet-stream"}),this.http.get(`api/dmc/v1/buckets/${e}/images/${t}/${s}`).pipe((0,p.tap)(()=>{this.userToken=null}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e)))))))}coverUploadEntireFile(e,t,s,i){return this.login().pipe((0,p.switchMap)(r=>{let n=-1;this.http.setThrowawayHeader({"digi-middleware-auth-user":r});let a={reportProgress:!0,observe:"events"};return a=this.dwHttpClientOptionsService.setLoadMaskCfg(a,!1),this.http.post(`api/dmc/v1/buckets/${t}/files/${s}/cover`,i,a).pipe((0,p.map)(e=>this.mapEvent(e)),(0,p.filter)(e=>{if(e.type===o.HttpEventType.UploadProgress){const t=this.getfilterFn(n)(e);return n=t?e.data.percent:n,t}return!0}),(0,p.tap)(t=>{!1===e&&t.type===o.HttpEventType.Response&&(this.userToken=null)}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e))))}))}createEmptyFile(e,t){return this.login().pipe((0,p.switchMap)(s=>(this.http.setThrowawayHeader({"digi-middleware-auth-user":s}),this.http.post(`api/dmc/v1/buckets/${e}/files/segment`,t).pipe((0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e)))))))}pieceUploadFile(e,t,s,i,r,n,a,c){return this.login().pipe((0,p.switchMap)(u=>{let h=`api/dmc/v1/buckets/${t}/files/${s}/${i}/${r}/${n}`;c&&(h=`api/dmc/v1/buckets/${t}/files/${s}/${i}/${r}/${n}/cover`);let d=-1;this.http.setThrowawayHeader({"digi-middleware-auth-user":u});let g={reportProgress:!0,observe:"events"};return g=this.dwHttpClientOptionsService.setLoadMaskCfg(g,!1),this.http.post(h,a,g).pipe((0,p.map)(e=>this.mapEvent(e)),(0,p.filter)(e=>{if(e.type===o.HttpEventType.UploadProgress){const t=this.getfilterFn(d)(e);return d=t?e.data.percent:d,t}return!0}),(0,p.tap)(t=>{!1===e&&t.type===o.HttpEventType.Response&&(this.userToken=null)}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e))))}))}download(e,t,s={loadMaskCfg:{spinning:!1,delay:0,tip:""}}){return this.login(s).pipe((0,p.switchMap)(i=>(this.http.setThrowawayHeader({"digi-middleware-auth-user":i,"Content-Type":"application/octet-stream"}),this.http.get(`api/dmc/v1/buckets/${e}/files/${t}`,{responseType:"blob",uiOptions:s}).pipe((0,p.tap)(()=>{this.userToken=null}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e)))))))}shareToAll(e,t){return this.login().pipe((0,p.switchMap)(s=>(this.http.setThrowawayHeader({"digi-middleware-auth-user":s}),this.http.post(`api/dmc/v1/buckets/${e}/ShareFiles`,t).pipe((0,p.tap)(()=>{this.userToken=null}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e)))))))}batchDelete(e,t,s){return this.login().pipe((0,p.switchMap)(i=>(this.http.setThrowawayHeader({"digi-middleware-auth-user":i}),this.http.post(`api/dmc/v1/buckets/${t}/files/delete/batch`,{fileIds:e,dirIds:s}).pipe((0,p.tap)(()=>{this.userToken=null}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e)))))))}newDirectorys(e,t,s){return this.login().pipe((0,p.switchMap)(i=>(this.http.setThrowawayHeader({"digi-middleware-auth-user":i}),this.http.post(`api/dmc/v1/buckets/${e}/directorys`,{parentId:t,name:s}).pipe((0,p.tap)(()=>{this.userToken=null}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e)))))))}getDirectorys(e,t){return this.login().pipe((0,p.switchMap)(s=>(this.http.setThrowawayHeader({"digi-middleware-auth-user":s}),this.http.get(`api/dmc/v1/buckets/${e}/directorys/${t}/list`).pipe((0,p.tap)(()=>{this.userToken=null}),(0,p.catchError)(e=>(this.userToken=null,(0,l.throwError)(e)))))))}}return e.\u0275fac=function(t){return new(t||e)(i.\u0275\u0275inject(w),i.\u0275\u0275inject(g),i.\u0275\u0275inject(r.DwHttpClientOptionsService),i.\u0275\u0275inject(h.DwUserService),i.\u0275\u0275inject(a.DW_DMC_USERINFO))},e.\u0275prov=i.\u0275\u0275defineInjectable({factory:function(){return new e(i.\u0275\u0275inject(w),i.\u0275\u0275inject(g),i.\u0275\u0275inject(r.DwHttpClientOptionsService),i.\u0275\u0275inject(h.DwUserService),i.\u0275\u0275inject(a.DW_DMC_USERINFO))},token:e,providedIn:r.DwHttpModule}),e})(),y=(()=>{class e{constructor(e,t){this.dmcRepository=e,this.dwDmcUserInfo=t,this.SLICESECTION=2611200,this.defaultBucketName="",this.defaultDirId="00000000-0000-0000-0000-000000000000",this.defaultBucketName=this.dwDmcUserInfo.username}upload(e,t,s,i){t=t||this.defaultBucketName,s=s||this.defaultDirId,i="boolean"==typeof i&&i;const r=new FileReader;return l.Observable.create(n=>{"object"==typeof e?e.size<=this.SLICESECTION?(this.pushFileMessage(n,"ongoing",0),this.entireUpload(r,e,t,s,n,i)):(this.pushFileMessage(n,"ongoing",0),this.newEmptyFile(e,t,s).subscribe(a=>{this.pushFileMessage(n,"ongoing",5),this.sliceUpload(r,e,a.id,t,s,0,this.SLICESECTION,n,i)},e=>{this.pushFileMessage(n,"error",e)})):this.pushFileMessage(n,"error","\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!")})}coverUpload(e,t,s,i,r){s=s||this.defaultBucketName,i=i||this.defaultDirId,r="boolean"==typeof r&&r;const n=new FileReader;return l.Observable.create(a=>{"object"==typeof e?t?(this.pushFileMessage(a,"ongoing",0),e.size<=this.SLICESECTION?this.entireCoverUpload(n,e,t,s,a,r):this.sliceUpload(n,e,t,s,i,0,this.SLICESECTION,a,r,!0)):this.pushFileMessage(a,"error","\u6587\u4ef6ID\u4e0d\u80fd\u70ba\u7a7a!"):this.pushFileMessage(a,"error","\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!")})}uploadAndShare(e,t,s){t=t||this.defaultBucketName,s=s||this.defaultDirId;let i="";return l.Observable.create(r=>{"object"==typeof e?this.upload(e,t,s,!0).pipe((0,p.filter)(e=>e.hasOwnProperty("fileId")&&e.fileId),(0,p.switchMap)(e=>(i=e.fileId,this.pushFileMessage(r,"shareToAll",50,i),this.dmcRepository.shareToAll(t,[i])))).subscribe(e=>{this.pushFileMessage(r,"success",100,i,e[0]),r.complete()},e=>{this.pushFileMessage(r,"error",e)}):this.pushFileMessage(r,"error","\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!")})}readAsArrayBuffer(e,t){return l.Observable.create(s=>{e.addEventListener("load",()=>{s.next(e.result),s.complete()}),e.readAsArrayBuffer(t)})}entireUpload(e,t,s,i,r,n){this.readAsArrayBuffer(e,t).pipe((0,p.switchMap)(e=>{const r={extension:this.getFileExtension(t.name),displayName:t.name,totalSize:t.size,segmentTotalSize:t.size,fileName:t.name,directoryId:i};return this.dmcRepository.uploadEntireFile(n,r,s,e)})).subscribe(e=>{e instanceof o.HttpResponse&&(this.pushFileMessage(r,"success",100,e.body.id),r.complete())},e=>{this.pushFileMessage(r,"error",e)})}imageUpload(e,t,s,i,r=!1){return l.Observable.create(n=>{const a=new FileReader;this.readAsArrayBuffer(a,e).pipe((0,p.switchMap)(n=>{const a={extension:this.getFileExtension(e.name),displayName:e.name,fileName:e.name,directoryId:s};return this.dmcRepository.imageUpload(r,a,t,n,i)})).subscribe(e=>{e instanceof o.HttpResponse&&(n.next({status:"success",data:100,originUrl:e.body.data.originUrl,shrinkUrl:e.body.data.shrinkUrl,fileId:e.body.data.fileId}),n.complete())},e=>{this.pushFileMessage(n,"error",e)})})}entireCoverUpload(e,t,s,i,r,n){this.readAsArrayBuffer(e,t).pipe((0,p.switchMap)(e=>this.dmcRepository.coverUploadEntireFile(n,i,s,e))).subscribe(e=>{e instanceof o.HttpResponse&&(this.pushFileMessage(r,"success",100,e.body.id),r.complete())},e=>{this.pushFileMessage(r,"error",e)})}newEmptyFile(e,t,s){return t=t||this.defaultBucketName,s=s||this.defaultDirId,l.Observable.create(i=>{const r={extension:this.getFileExtension(e.name),displayName:e.name,fileName:e.name,directoryId:s};this.dmcRepository.createEmptyFile(t,r).subscribe(e=>{i.next(e),i.complete()},e=>{i.error(e),i.complete()})})}sliceUpload(e,t,s,i,r,n,a,l,c,u){const h=t.slice(n,a);u=u||!1;let d=!0;this.readAsArrayBuffer(e,h).pipe((0,p.switchMap)(e=>(a===t.size&&!1===c&&(d=c),this.dmcRepository.pieceUploadFile(d,i,s,n,a-1,t.size,e,u)))).subscribe(p=>{if(p instanceof o.HttpResponse){if(a===t.size)return this.pushFileMessage(l,"success",100,p.body.id),void l.complete();this.pushFileMessage(l,"ongoing",100*a/t.size),this.sliceUpload(e,t,s,i,r,n+this.SLICESECTION,a+this.SLICESECTION>t.size?t.size:a+this.SLICESECTION,l,c,u)}},e=>{this.pushFileMessage(l,"error",e)})}download(e,t,s){return s=s||this.defaultBucketName,l.Observable.create(i=>{e&&t?this.dmcRepository.download(s,e).subscribe(e=>{const s=window.document.createElement("a"),r=window.URL.createObjectURL(e);s.href=r,s.download=t,document.body.appendChild(s);const n=document.createEvent("MouseEvents");n.initEvent("click",!1,!1),s.dispatchEvent(n),window.URL.revokeObjectURL(r),document.body.removeChild(s),this.pushFileMessage(i,"success",100),i.complete()},e=>{this.pushFileMessage(i,"error",e)}):this.pushFileMessage(i,"error","\u6587\u4ef6 ID\u8207\u6a94\u540d\u4e0d\u5f97\u70ba\u7a7a")})}deleteFile(e=[],t,s=[]){return t=t||this.defaultBucketName,l.Observable.create(i=>{0!==e.length?this.dmcRepository.batchDelete(e,t,s).subscribe(e=>{this.pushFileMessage(i,"success","\u5220\u9664\u6210\u529f"),i.complete()},e=>{this.pushFileMessage(i,"error",e)}):this.pushFileMessage(i,"error","\u522a\u9664\u6578\u7d44\u4e0d\u80fd\u70ba\u7a7a!")})}getFileExtension(e){const t=e.lastIndexOf(".");return e.substring(t+1)}pushFileMessage(e,t,s,i,r){const n={status:t,data:s};i&&(n.fileId=i),r&&(n.shareUrl=r),"error"===t?e.error(n):e.next(n)}}return e.\u0275fac=function(t){return new(t||e)(i.\u0275\u0275inject(b),i.\u0275\u0275inject(a.DW_DMC_USERINFO))},e.\u0275prov=i.\u0275\u0275defineInjectable({factory:function(){return new e(i.\u0275\u0275inject(b),i.\u0275\u0275inject(a.DW_DMC_USERINFO))},token:e,providedIn:f}),e})(),v=(()=>{class e{constructor(e,t,s){this.zone=e,this.dmcRepository=t,this.dwDmcUserInfo=s,this._activeSilceUplodLimit=2611200,this.SLICESECTION=2611200,this.defaultBucketName="",this.defaultDirId="00000000-0000-0000-0000-000000000000",this.uploadingSubscriptions=[],this.defaultBucketName=this.dwDmcUserInfo.username}upload(e,t,s,i){t=t||this.defaultBucketName,s=s||this.defaultDirId,i="boolean"==typeof i&&i;const r=new FileReader;return new l.Observable(n=>{e instanceof File?e.size<=this._activeSilceUplodLimit?this.entireUpload(r,e,t,s,n,i):this.newEmptyFile(e,t,s).subscribe(a=>{this.pushFileMessage(n,{status:"ongoing",percent:1}),this.sliceUpload(r,e,a.id,t,s,0,this.SLICESECTION,n,i)},e=>{this.pushFileMessage(n,{status:"error",message:e})}):this.pushFileMessage(n,{status:"error",message:"\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!"})})}coverUpload(e,t,s,i,r){s=s||this.defaultBucketName,i=i||this.defaultDirId,r="boolean"==typeof r&&r;const n=new FileReader;return new l.Observable(a=>{e instanceof File?t?e.size<=this._activeSilceUplodLimit?this.entireCoverUpload(n,e,t,s,a,r):this.sliceUpload(n,e,t,s,i,0,this.SLICESECTION,a,r):this.pushFileMessage(a,{status:"error",message:"\u6587\u4ef6ID\u4e0d\u80fd\u70ba\u7a7a!"}):this.pushFileMessage(a,{status:"error",message:"\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!"})})}uploadAndShare(e,t,s){t=t||this.defaultBucketName,s=s||this.defaultDirId;let i="";return new l.Observable(r=>{e instanceof File?this.upload(e,t,s,!0).subscribe(e=>{"success"===e.status?(i=e.fileId,this.pushFileMessage(r,{status:"ongoing",percent:99,fileId:e.fileId}),this.dmcRepository.shareToAll(t,[i]).subscribe(e=>{this.pushFileMessage(r,{status:"success",percent:100,fileId:i,shareUrl:e[0]}),r.complete()},e=>{this.pushFileMessage(r,{status:"error",message:e})})):"ongoing"===e.status&&e.percent&&this.pushFileMessage(r,{status:"ongoing",percent:e.percent,fileId:e.fileId})},e=>{this.pushFileMessage(r,e)}):this.pushFileMessage(r,{status:"error",message:"\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!"})})}uploadFile(e,t=!0,s,i,r={shrink:"1",isShareShrink:"1",width:"150"},n=this._activeSilceUplodLimit){return r.shrink=r.shrink?r.shrink:"1",r.isShareShrink=r.isShareShrink?r.isShareShrink:"1",!r.width&&!r.height&&(r.width="150"),s=s||this.defaultBucketName,i=i||this.defaultDirId,this._activeSilceUplodLimit=n>209715200?209715200:this._activeSilceUplodLimit,new l.Observable(n=>{if(!(e instanceof File))return void this.pushFileMessage(n,{status:"error",message:"\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!"});const a=new RegExp("image/(jpg|png|gif|jpeg|bmp)","i");e.type.match(a)?t?this.imageUploadAndShare(e,s,i,r).subscribe(e=>{n.next(e)},e=>{n.error(e)}):this.upload(e,s,i,!0).subscribe(e=>{"success"===e.status?"1"===r.shrink?this.dmcRepository.shrinkImageByFileId(s,e.fileId,r).subscribe(t=>{this.pushFileMessage(n,{status:"success",percent:100,shareUrl:null,shrinkUrl:t.data.shareUrl?t.data.shareUrl:null,shrinkId:t.data.fileId,fileId:e.fileId}),n.complete()},e=>{this.pushFileMessage(n,{status:"error",message:e})}):(this.pushFileMessage(n,{status:"success",percent:100,shareUrl:null,shrinkUrl:null,shrinkId:null,fileId:e.fileId}),n.complete()):this.pushFileMessage(n,e)},e=>{n.error(e)}):t?this.uploadAndShare(e,s,i).subscribe(e=>{"success"===e.status?(this.pushFileMessage(n,{status:"success",percent:100,shareUrl:e.shareUrl,shrinkUrl:null,shrinkId:null,fileId:e.fileId}),n.complete()):n.next(e)},e=>{n.error(e)}):this.upload(e,s,i,!0).subscribe(e=>{"success"===e.status?(this.pushFileMessage(n,{status:"success",percent:100,shareUrl:null,shrinkUrl:null,shrinkId:null,fileId:e.fileId}),n.complete()):this.pushFileMessage(n,e)},e=>{n.error(e)})})}imageUploadAndShare(e,t,s,i={shrink:"1",share:"1",width:"150"}){return t=t||this.defaultBucketName,s=s||this.defaultDirId,new l.Observable(r=>{e instanceof File?"1"!==i.shrink?this.uploadAndShare(e,t,s).subscribe(e=>{"success"===e.status?(this.pushFileMessage(r,{status:"success",percent:100,shareUrl:e.shareUrl,shrinkUrl:null,shrinkId:null,fileId:e.fileId}),r.complete()):r.next(e)},e=>{r.error(e)}):this.uploadAndShare(e,t,s).subscribe(e=>{"success"===e.status?this.dmcRepository.shrinkImageByFileId(t,e.fileId,i).subscribe(t=>{this.pushFileMessage(r,{status:"success",percent:100,shareUrl:e.shareUrl,shrinkUrl:t.data.shareUrl?t.data.shareUrl:null,shrinkId:t.data.fileId,fileId:e.fileId}),r.complete()},e=>{this.pushFileMessage(r,{status:"error",message:e})}):this.pushFileMessage(r,e)},e=>{this.pushFileMessage(r,e)}):this.pushFileMessage(r,{status:"error",message:"\u4e0a\u50b3\u6587\u4ef6\u4e0d\u80fd\u70ba\u7a7a!"})})}readAsArrayBuffer(e,t){return new l.Observable(s=>{e.addEventListener("load",()=>{s.next(e.result),s.complete()}),e.readAsArrayBuffer(t)})}entireUpload(e,t,s,i,r,n){const a=this.readAsArrayBuffer(e,t).pipe((0,p.switchMap)(e=>{const r={extension:this.getFileExtension(t.name),displayName:t.name,totalSize:t.size,segmentTotalSize:t.size,fileName:t.name,directoryId:i};return this.dmcRepository.uploadEntireFile(n,r,s,e)})).subscribe(e=>{e instanceof o.HttpResponse?(this.deleteUploadingSubsciption(t.uid),this.pushFileMessage(r,{status:"success",percent:100,fileId:e.body.id}),r.complete()):(e.type===o.HttpEventType.UploadProgress||e.type===o.HttpEventType.Sent)&&this.pushFileMessage(r,{status:"ongoing",percent:e.data.percent})},e=>{this.pushFileMessage(r,{status:"error",message:e})});this.uploadingSubscriptions.push({uid:t.uid,subscription:a})}imageUpload(e,t,s,i,r=!1){return new l.Observable(n=>{const a=new FileReader,l=this.readAsArrayBuffer(a,e).pipe((0,p.switchMap)(n=>{const a={extension:this.getFileExtension(e.name),displayName:e.name,fileName:e.name,directoryId:s};return this.dmcRepository.imageUpload(r,a,t,n,i)})).subscribe(t=>{t instanceof o.HttpResponse?(this.deleteUploadingSubsciption(e.uid),this.pushFileMessage(n,{status:"success",percent:100,shareUrl:t.body.data.originUrl,shrinkUrl:t.body.data.shrinkUrl,shrinkId:t.body.data.shrinkId,fileId:t.body.data.fileId}),n.complete()):(t.type===o.HttpEventType.UploadProgress||t.type===o.HttpEventType.Sent)&&this.pushFileMessage(n,{status:"ongoing",percent:t.data.percent})},e=>{this.pushFileMessage(n,{status:"error",message:e})});this.uploadingSubscriptions.push({uid:e.uid,subscription:l})})}entireCoverUpload(e,t,s,i,r,n){const a=this.readAsArrayBuffer(e,t).pipe((0,p.switchMap)(e=>this.dmcRepository.coverUploadEntireFile(n,i,s,e))).subscribe(e=>{e instanceof o.HttpResponse?(this.deleteUploadingSubsciption(t.uid),this.pushFileMessage(r,{status:"success",percent:100,fileId:e.body.id}),r.complete()):(e.type===o.HttpEventType.UploadProgress||e.type===o.HttpEventType.Sent)&&this.pushFileMessage(r,{status:"ongoing",percent:e.data.percent})},e=>{this.pushFileMessage(r,{status:"error",message:e})});this.uploadingSubscriptions.push({uid:t.uid,subscription:a})}newEmptyFile(e,t,s){return t=t||this.defaultBucketName,s=s||this.defaultDirId,new l.Observable(i=>{const r={extension:this.getFileExtension(e.name),displayName:e.name,fileName:e.name,directoryId:s};this.dmcRepository.createEmptyFile(t,r).subscribe(e=>{i.next(e),i.complete()},e=>{i.error(e),i.complete()})})}sliceUpload(e,t,s,i,r,n,a,l,c,u){const h=t.slice(n,a);u=u||!1;let d=!0,g=-1;const m=this.readAsArrayBuffer(e,h).pipe((0,p.switchMap)(e=>(a===t.size&&!1===c&&(d=c),this.dmcRepository.pieceUploadFile(d,i,s,n,a-1,t.size,e,u)))).subscribe(p=>{if(p instanceof o.HttpResponse){if(this.deleteUploadingSubsciption(t.uid),a===t.size)return this.pushFileMessage(l,{status:"success",percent:100,fileId:s}),void l.complete();this.sliceUpload(e,t,s,i,r,n+this.SLICESECTION,a+this.SLICESECTION>t.size?t.size:a+this.SLICESECTION,l,c,u)}else if((p.type===o.HttpEventType.UploadProgress||p.type===o.HttpEventType.Sent)&&p.type===o.HttpEventType.UploadProgress){const e=Math.round(100*(p.loaded+n)/t.size);g!==e&&(this.pushFileMessage(l,{status:"ongoing",percent:100===e?99:e}),g=e)}},e=>{this.pushFileMessage(l,{status:"error",message:e})});this.uploadingSubscriptions.push({uid:t.uid,subscription:m,fileId:s,uplodFrom:n,bucketName:i,dirId:r})}download(e,t,s){return s=s||this.defaultBucketName,new l.Observable(i=>{e&&t?this.dmcRepository.download(s,e).subscribe(e=>{const s=window.document.createElement("a"),r=window.URL.createObjectURL(e);s.href=r,s.download=t,document.body.appendChild(s);const n=document.createEvent("MouseEvents");n.initEvent("click",!1,!1),s.dispatchEvent(n),window.URL.revokeObjectURL(r),document.body.removeChild(s),this.pushFileMessage(i,{status:"success",percent:100}),i.complete()},e=>{this.pushFileMessage(i,{status:"error",message:e})}):this.pushFileMessage(i,{status:"error",message:"\u6587\u4ef6 ID\u8207\u6a94\u540d\u4e0d\u5f97\u70ba\u7a7a"})})}deleteFile(e=[],t){return t=t||this.defaultBucketName,new l.Observable(s=>{0!==e.length?this.dmcRepository.batchDelete(e,t,[]).subscribe(e=>{this.pushFileMessage(s,{status:"success",message:"\u5220\u9664\u6210\u529f"}),s.complete()},e=>{this.pushFileMessage(s,{status:"error",message:e})}):this.pushFileMessage(s,{status:"error",message:"\u522a\u9664\u6578\u7d44\u4e0d\u80fd\u70ba\u7a7a!"})})}getFileExtension(e){const t=e.lastIndexOf(".");return e.substring(t+1)}pushFileMessage(e,t){const s=t;"error"===t.status?e.error(s):e.next(s)}newDirectorys(e,t,s){return this.dmcRepository.newDirectorys(s=s||this.defaultBucketName,t=t||this.defaultDirId,e)}getDirectorys(e,t){return this.dmcRepository.getDirectorys(t=t||this.defaultBucketName,e=e||this.defaultDirId)}cancelUploading(e){this.uploadingSubscriptions.forEach(t=>{t.uid===e&&t.subscription&&(t.subscription.unsubscribe(),t.hasOwnProperty("fileId")&&this.zone.runOutsideAngular(()=>{(e=>{setTimeout(()=>{this.deleteFile([e.fileId],e.bucketName).subscribe()},0)})(t)}))})}deleteUploadingSubsciption(e){const t=this.uploadingSubscriptions.findIndex(t=>t.uid===e);this.uploadingSubscriptions.splice(t,1)}getDataUrlAndBlobByFileId(e,t,s){return this.dmcRepository.download(t=t||this.defaultBucketName,e,s).pipe((0,p.switchMap)(e=>new l.Observable(t=>{const s=new FileReader;s.onload=s=>{t.next({dataUrl:s.target.result,blob:e}),t.complete()},s.readAsDataURL(e)})))}}return e.\u0275fac=function(t){return new(t||e)(i.\u0275\u0275inject(i.NgZone),i.\u0275\u0275inject(b),i.\u0275\u0275inject(a.DW_DMC_USERINFO))},e.\u0275prov=i.\u0275\u0275defineInjectable({factory:function(){return new e(i.\u0275\u0275inject(i.NgZone),i.\u0275\u0275inject(b),i.\u0275\u0275inject(a.DW_DMC_USERINFO))},token:e,providedIn:f}),e})()}}]);