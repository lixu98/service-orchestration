"use strict";(self.webpackChunkassc_crs=self.webpackChunkassc_crs||[]).push([[8722,664],{68722:function(t,e,r){r.r(e),r.d(e,{DwTabClose:function(){return T},DwTabEvent:function(){return g},DwTabFocusin:function(){return v},DwTabFocusout:function(){return x},DwTabInfoService2:function(){return p},DwTabInfoStorageService:function(){return A},DwTabOpen:function(){return y},DwTabRouteConfigService:function(){return b},DwTabRoutingService:function(){return I}});var i=r(64762),n=r(42746),a=r(32276),s=r(71049),o=r(87974),u=r(30469),h=r(20033),c=r(47372),l=r(68521),d=r(27038),S=r(50437),f=r(62481);let b=(()=>{class t{constructor(t,e,r,i,n,a){this.authPermissionInfoService=t,this.operationInfoListService=e,this.operationInfoService=r,this.defaultAppRouterService=i,this.dwLanguagePreService=n,this.tabRouteConfigJson=a}newConfig(t,e){let r={id:"",title:"",menuId:"",routerLink:"",type:""};return t&&(r=Object.assign(r,e),r.routerLink=t.routerLink,r.type=t.type),r}get routeConfigInfos$(){return s.Observable.create(t=>{let e=null;e=this.operationInfoListService.operationListMap$.subscribe(r=>{if(null!==r){const i=Object.assign({},r);let n=null;n=this.authPermissionInfoService.authorizedList$.subscribe(r=>{const a=Object.assign({},r),s=[];let o=null;o=this.defaultAppRouterService.defaultAppInfo$.subscribe(r=>{let u=JSON.parse(JSON.stringify(this.tabRouteConfigJson));Array.isArray(u)||(u=[]);let h=!1;if(r.programId){const t=u.length;for(let e=0;e<t;e++)"home"===u[0].id&&(h=!0,u[0].id=r.programId,u[0].title=this.dwLanguagePreService.program+"dw-home",u[0].type=r.execType,u[0].queryParams=JSON.parse(JSON.stringify(r.queryParams)));if(!h){h=!0;const t={id:"home",title:"",canClose:!1,defaultOpen:!0,canMultiOpen:!1,iconClass:"dwType:home",routerLink:""};r.programId&&(t.id=r.programId,u[0].title=this.dwLanguagePreService.program+"dw-home",t.type=r.execType,t.queryParams=JSON.parse(JSON.stringify(r.queryParams))),u.splice(0,0,t)}}u.forEach(t=>{const e=t.id;let r=!1;if((a[e]||"externalUrl"===t.type)&&(r=!0),r){let r=i[e];if(void 0===r){const i=this.operationInfoService.operationBaseByType(t.type,e);i.type&&(r=Object.assign({},i))}const n=this.newConfig(r,t);""!==n.id&&s.push(n)}}),t.next({tabRouteConfig:s,operationListMap:i}),t.complete(),o&&o.unsubscribe(),n&&n.unsubscribe(),e&&e.unsubscribe()})},t=>console.log(t))}})})}}return t.\u0275fac=function(e){return new(e||t)(n.\u0275\u0275inject(a.DwAuthPermissionInfoService),n.\u0275\u0275inject(h.DwOperationInfoListService),n.\u0275\u0275inject(h.DwOperationInfoService),n.\u0275\u0275inject(l.DwDefaultAppRouterService),n.\u0275\u0275inject(l.DwLanguagePreService),n.\u0275\u0275inject(u.DW_TAB_ROUTE_CONFIG_JSON))},t.\u0275prov=n.\u0275\u0275defineInjectable({factory:function(){return new t(n.\u0275\u0275inject(a.DwAuthPermissionInfoService),n.\u0275\u0275inject(h.DwOperationInfoListService),n.\u0275\u0275inject(h.DwOperationInfoService),n.\u0275\u0275inject(l.DwDefaultAppRouterService),n.\u0275\u0275inject(l.DwLanguagePreService),n.\u0275\u0275inject(u.DW_TAB_ROUTE_CONFIG_JSON))},token:t,providedIn:"root"}),t})(),p=(()=>{class t{constructor(t,e,r,i,n,a,u,h,c,l,d){this.router=t,this.authService=e,this.routerInfo=r,this.routerConfigService=i,this.dwLanguagePreService=n,this.operationInfoService=a,this.iframeGeneralInfoService=u,this.iframeFineReportInfoService=h,this.TAB_MULTI_OPEN=c,this.DEFAULT_APP=l,this.OPEN_DEFAULT_WHEN_CLOSE_TABS=d,this.create$=new s.Subject,this.tabSetStateArray=[],this.currentTabInfo=null,this.previousTabInfo=null,this.currentIndex=-1,this.previousIndex=-1,this.isTabChanged=!1,this.selectedIndexChange=new s.Subject,this.tabSetIndexChanged=new s.Subject,this.isStarted=!1,this.shouldStop=!1,this.shouldDestroyTab=null,this.currentRouteSnapshot=null,this.isNavigationPopState=!1,this.readyToDestroy=!1,this.tabRouteConfig=[],this.defaultTabCreating=!1,this._tabRouterChanged=new s.BehaviorSubject(null),this.router.events.subscribe(t=>{if(t instanceof o.NavigationStart&&(this.isNavigationPopState="popstate"===t.navigationTrigger),t instanceof o.NavigationEnd&&this.isStarted&&this.canMultiOpen(this.tabSetStateArray[this.currentIndex])){this.tabSetStateArray[this.currentIndex].hasOwnProperty("histories")||(this.tabSetStateArray[this.currentIndex].histories=[]);const e=this.tabSetStateArray[this.currentIndex].histories,r=e.findIndex(e=>e===t.urlAfterRedirects);-1!==r&&e.splice(r,1),e.push(t.urlAfterRedirects),e.length>20&&e.shift()}})}get tabRouterChanged(){return this._tabRouterChanged.isStopped&&(this._tabRouterChanged=new s.BehaviorSubject(null)),this._tabRouterChanged}static isUnderHosting(t){if(!t)return!1;let e,r=!1;for(let i=0;i<t.pathFromRoot.length-1;i++)if(e=t.pathFromRoot[i],e.routeConfig&&e.routeConfig.data&&e.routeConfig.data.tabSetHosting){r=!0;break}return r}static routeToUrl(t){return t.url?t.url.length?t.url.join("/"):"function"==typeof t.component?`[${t.component.name}]`:"string"==typeof t.component?`[${t.component}]`:"[null]":"(null)"}static getResolvedUrl(t){return t.pathFromRoot.map(t=>t.url.map(t=>t.toString()).join("/")).join("/")}close(t){const e=this.tabSetStateArray.length;if(!1!==this.tabSetStateArray[t].canClose)if(this.shouldDestroyTab=this.tabSetStateArray[t],t!==this.currentIndex)this.destroyTabRouteState(this.shouldDestroyTab),this.shouldDestroyTab=null,this.tabSetStateArray.splice(t,1),t<this.currentIndex&&(this.currentIndex=this.currentIndex-1,this.currentTabInfo=this.tabSetStateArray[this.currentIndex],this.tabSetIndexChanged.next(this.currentIndex)),t<=this.previousIndex&&(t===this.previousIndex?(this.previousIndex=this.currentIndex,this.previousTabInfo=this.tabSetStateArray[this.previousIndex]):(this.previousIndex=this.previousIndex-1,this.previousTabInfo=this.tabSetStateArray[this.previousIndex]));else{this.tabSetStateArray[t].canDestroy=!0,this.readyToDestroy=!0;let r,i=this.tabSetStateArray.length-1;if(this.shouldDestroyTab.opener&&(r=this.tabSetStateArray.find(t=>t.tabId===this.shouldDestroyTab.opener),r&&(i=this.tabSetStateArray.indexOf(r))),r||(i=this.previousIndex!==t?this.previousIndex:t===this.tabSetStateArray.length-1?t-1:t+1),1===e)return this.OPEN_DEFAULT_WHEN_CLOSE_TABS?void this.closeAll():(this.currentIndex=-1,this.previousIndex=-1,void this.destroyReadyToDestroyRouteInfo());this.setCurrentIndex(i)}}createFromRouteInfo(t,e){let r=!1;this.isTabChanged=!0,void 0===t.queryParams&&(t.queryParams={});const i=t;if(void 0===i.navigateHistory&&(i.navigateHistory=new Map),i.tabId||(i.tabId=e||this.createTabId()),e){const t=this.tabSetStateArray.find(t=>t.id===e||t.tabId===e);t&&(e=t.tabId)}if(i.title||(i.title=i.id?this.dwLanguagePreService.program+i.id:""),this.create$.next(i),!this.canMultiOpen(i)||this.isNavigationPopState)for(let a=0;a<this.tabSetStateArray.length;a++)if(this.isTabEqual(i,this.tabSetStateArray[a],!0)){this.tabSetStateArray[a].title=i.title,this.previousIndex=this.currentIndex,this.currentIndex=a,r=!0,this.isTabChanged=this.currentIndex!==this.previousIndex,this.tabSetIndexChanged.next(this.currentIndex);const e=this.router.onSameUrlNavigation;return this.router.onSameUrlNavigation="reload",this.isNavigationPopState||this.router.navigateByUrl(this.tabSetStateArray[a].currentUrl||t.routerLink),this.router.onSameUrlNavigation=e,this.tabSetStateArray[a].tabId}if(e){let t,n=-1;for(let i=0;i<this.tabSetStateArray.length;i++)if(t=this.tabSetStateArray[i],t.tabId===e){n=i,r=!0;break}n>-1&&(n===this.currentIndex?this.isTabChanged=!1:(this.tabSetStateArray[n].opener||(this.tabSetStateArray[n].opener=this.tabSetStateArray[this.currentIndex].tabId),this.tabSetStateArray[n].title=i.title,this.previousIndex=this.currentIndex,this.currentIndex=n))}r||(-1===this.currentIndex&&(this.currentIndex=0),this.tabSetStateArray.push(i),i.opener=this.tabSetStateArray[this.currentIndex].tabId,this.previousIndex=this.currentIndex,this.currentIndex=this.tabSetStateArray.length-1);const n=this.router.onSameUrlNavigation;return this.router.onSameUrlNavigation="reload",this.isNavigationPopState||this.router.navigateByUrl(i.routerLink),this.router.onSameUrlNavigation=n,this.tabSetIndexChanged.next(this.currentIndex),i.tabId}shouldAttach(t){var e;this.currentRouteSnapshot=t;let r=!1;if(!this.isStarted||t&&t.data&&!1===t.data.tabCache)return!1;if(this.isNavigationPopState){const e=this.createTabRouteState(t),r=this.existInTabsIndex(e);-1!==r?this.setCurrentIndex(r):this.createFromRouteInfo(e),"externalUrl"===this.tabSetStateArray[this.currentIndex].type&&(this.tabSetStateArray[this.currentIndex].title=this.dwLanguagePreService.menu+this.tabSetStateArray[this.currentIndex].id),this.isNavigationPopState=!1,this.tabSetIndexChanged.next(this.currentIndex)}if(r=this.checkExistsByRoute(t),!r&&!t.routeConfig.children&&!(null===(e=this.tabSetStateArray[this.currentIndex])||void 0===e?void 0:e.id)){const e=this.tabSetStateArray[this.currentIndex];this.operationInfoService.routerOperationInfo(t).pipe((0,c.first)()).subscribe(t=>{e.id=t.id})}this.tabSetStateArray[this.currentIndex].currentUrl=this.getFullUrl(t);const i=this.tabSetStateArray[this.currentIndex];return("fineReport"===i.type||"externalUrl"===i.type)&&void 0===i.item&&this.operationInfoService.routerOperationInfo(t).pipe((0,c.first)()).subscribe(t=>{Object.assign(i,t),i.type&&this.setIframeInfo(i)}),this.currentTabInfo=this.tabSetStateArray[this.currentIndex],r}shouldDetach(e){const r=this.isStarted;return!(!this.isStarted||(this.isTabChanged?this.tabSetStateArray[this.previousIndex].currentUrl=this.getFullUrl(e):this.tabSetStateArray[this.currentIndex].currentUrl=this.getFullUrl(e),e&&e.data&&!1===e.data.tabCache))&&(t.isUnderHosting(e)||this.destroyTabHistory(this.tabSetStateArray[this.previousIndex]),this.currentTabInfo=this.tabSetStateArray[this.currentIndex],r)}retrieve(e){if("**"===e.routeConfig.path)return null;const r=t.isUnderHosting(e);if(this.currentRouteSnapshot=e,this.shouldStop=!r&&!this.isStarted,!this.isStarted)return;const i=this.getRouteKey(e);let n;-1===this.currentIndex&&(this.currentIndex=this.previousIndex=this.tabSetStateArray.length),void 0===this.tabSetStateArray[this.currentIndex]&&(n=this.createTabRouteState(e),this.tabSetStateArray[this.currentIndex]=Object.assign({},n),this.tabSetStateArray[this.currentIndex].navigateHistory.set(n.key,n)),void 0===this.tabSetStateArray[this.currentIndex].key&&(this.tabSetStateArray[this.currentIndex].key=i),this.previousTabInfo=this.currentIndex!==this.previousIndex?this.tabSetStateArray[this.previousIndex]:this.tabSetStateArray[this.currentIndex],!0===this.defaultTabCreating&&this.createDefaultTabs(this.tabRouteConfig,this.currentTabInfo),this.currentTabInfo=this.tabSetStateArray[this.currentIndex];let a=this.tabSetStateArray[this.currentIndex].navigateHistory.get(i);if(void 0===a&&(a=this.createTabRouteState(e),this.tabSetStateArray[this.currentIndex].navigateHistory.set(a.key,a)),this.isStarted){const t=this.tabSetStateArray[this.currentIndex];(void 0===t.type||("fineReport"===t.type||"externalUrl"===t.type)&&void 0===t.item)&&this.operationInfoService.routerOperationInfo(e).pipe((0,c.first)()).subscribe(e=>{if(Object.assign(t,e),(void 0===t.canMultiOpen||void 0===t.reload)&&this.tabRouteConfig.length>0){const e=this.tabRouteConfig.find(e=>this.isTabEqual(t,e));e&&Object.assign(t,{reload:e.reload||!1,canMultiOpen:e.canMultiOpen||this.TAB_MULTI_OPEN})}})}const s=this.getCurrentHandler(e);s&&s.id&&(this.tabSetStateArray[this.currentIndex].id=s.id),s&&!this.currentTabInfo.lastPath&&(this.currentTabInfo.lastPath=this.getLastNonemptyPath(e)),this.selectedIndexChange.next(this.currentIndex),this.tabSetIndexChanged.next(this.currentIndex);const o=this.findFirstChildComponentType(e);return s&&s.currentHandler?s.currentHandler.get(o):void 0}setCurrentIndex(t){if(this.currentIndex===t)return;const e=this.tabSetStateArray[t];if(null===e)return void console.error("\u627e\u4e0d\u5230\u6b63\u78ba\u7684\u8def\u7531");e.currentUrl||(e.currentUrl=e.routerLink),this.previousIndex=this.currentIndex,this.currentIndex=t,this.isTabChanged=!0;const r=this.router.onSameUrlNavigation;this.router.onSameUrlNavigation="reload",this.isNavigationPopState||this.router.navigateByUrl(e.currentUrl),this.router.onSameUrlNavigation=r,this.selectedIndexChange.next(this.currentIndex),this.tabSetIndexChanged.next(this.currentIndex)}store(e,r){const i=this.getRouteKey(e);let n;n=this.isTabChanged?this.tabSetStateArray[this.previousIndex]:this.tabSetStateArray[this.currentIndex];let a=n.navigateHistory.get(i);if(void 0===a&&(a=this.createTabRouteState(e)),this.tabChangeState={previousTabId:a.tabId,currentTabId:this.tabSetStateArray[this.currentIndex].tabId,tabChanged:this.isTabChanged},this.isTabChanged=!1,this.canReload(a,e)||!t.isUnderHosting(e))r.componentRef.destroy();else{n.navigateHistory.set(i,a),a&&!a.currentHandler&&(a.currentHandler=new Map);const t=this.findFirstChildComponentType(e);a.currentHandler.set(t,r)}this.shouldStop?this.destroy():(this.readyToDestroy&&this.destroyReadyToDestroyRouteInfo(),this.shouldDestroyTab&&(this.destroyTabRouteState(this.shouldDestroyTab),this.shouldDestroyTab=null))}findFirstChildComponentType(t){if(t.component)return t.component;let e=t.firstChild;for(;e;){if(e.component)return e.component;e=e.firstChild}}closeAll(){if(0===this.tabSetStateArray.length)return;const t=[];let e=null;this.tabSetStateArray.forEach(r=>{!1===this.isStarted?(r.canDestroy=!0,this.readyToDestroy=!0):(r.canDestroy="home"!==r.id&&r.routerLink!==this.DEFAULT_APP&&(void 0===r.canClose||r.canClose),this.OPEN_DEFAULT_WHEN_CLOSE_TABS||(r.canDestroy=!0),!0!==r.canDestroy?(t.push(r.tabId),e=r):this.readyToDestroy=!0)});let r=this.DEFAULT_APP||"/";if(!1===this.tabSetStateArray[this.currentIndex].canClose)r=null,e=null,this.destroyReadyToDestroyRouteInfo();else{const i=this.tabSetStateArray[this.previousIndex];if(i&&!1===i.canClose){e=null,r=i.currentUrl;const t=this.currentIndex;this.currentIndex=this.previousIndex,this.previousIndex=t,this.isTabChanged=!0}if(null!==e){const t=this.tabSetStateArray.indexOf(e);!1===e.canDestroy&&(t===this.currentIndex?this.destroyReadyToDestroyRouteInfo():(this.currentIndex=t,this.isTabChanged=!0),r=e.currentUrl)}else 0===t.length&&(this.currentIndex=-1)}if(!0===this.isStarted&&r&&this.OPEN_DEFAULT_WHEN_CLOSE_TABS){const t=this.router.onSameUrlNavigation;this.router.onSameUrlNavigation="reload",this.router.navigateByUrl(r),this.router.onSameUrlNavigation=t}else this.destroyReadyToDestroyRouteInfo();this.isNavigationPopState=!1,this.shouldDestroyTab=null}restart(){console.log("DwTabInfoService2.restart() not implemented")}navigateToOpenerFromCurrentTab(t,e,r){let i=r;const n=this.tabSetStateArray[this.currentIndex].opener;let a=-1;for(let s=0;s<this.tabSetStateArray.length;s++)if(this.tabSetStateArray[s].tabId===n){a=s,this.previousIndex=this.currentIndex,this.currentIndex=a;break}if(this.isTabChanged=!0,t&&-1===a){let r;i=!1,r=e?this.router.createUrlTree(t,e):this.router.createUrlTree(t),this.tabSetStateArray[this.currentIndex].opener=null,this.tabSetStateArray[this.currentIndex].title="",this.previousIndex=this.currentIndex;const n=new o.DefaultUrlSerializer,a=this.router.onSameUrlNavigation;this.router.onSameUrlNavigation="reload",this.router.navigateByUrl(n.serialize(r)),this.router.onSameUrlNavigation=a}else{this.isTabChanged=this.currentIndex!==this.previousIndex;const t=this.router.onSameUrlNavigation;this.router.onSameUrlNavigation="reload",this.router.navigateByUrl(this.tabSetStateArray[a].currentUrl||this.tabSetStateArray[a].routerLink),this.router.onSameUrlNavigation=t}this.isTabChanged&&(this.readyToDestroy=this.tabSetStateArray[this.previousIndex].canDestroy=!0===i),this.tabSetIndexChanged.next(this.currentIndex)}closeCurrentTab(){this.close(this.currentIndex)}createFirstRouteFromCurrentRoute(t){if(this.isStarted=!0,this.readyToDestroy=!1,!this.currentRouteSnapshot)return;const e=this.createTabRouteState(this.currentRouteSnapshot);this.currentTabInfo=this.previousTabInfo=e,-1===this.currentIndex&&(this.currentIndex=this.previousIndex=this.tabSetStateArray.length),void 0===this.tabSetStateArray[this.currentIndex]&&(this.tabSetStateArray[this.currentIndex]=e),this.tabSetStateArray[this.currentIndex].navigateHistory.set(e.key,Object.assign({},e)),this.createFromTabConfig(t)}createFromTabConfig(t){this.routerConfigService.routeConfigInfos$.pipe((0,c.first)()).subscribe(e=>{if(this.defaultTabCreating=!0,this.tabRouteConfig=e.tabRouteConfig,t){let r=0,i=t.tabs[r];for(;i;)i.defaultOpen=!0,e.operationListMap[i.id]||"fineReport"===i.type||"externalUrl"===i.type?r+=1:t.tabs.splice(r,1),i=t.tabs[r];t.currentIndex>=t.tabs.length&&(t.currentIndex=0)}this.createDefaultTabs(this.tabRouteConfig,this.currentTabInfo,t)})}getCurrentHandler(t){let e;return e="string"!=typeof t?this.getRouteKey(t):t,this.tabSetStateArray[this.currentIndex].navigateHistory.get(e)||void 0}destroy(){this.isStarted=!1,this.shouldStop=!1,this.currentRouteSnapshot=null,this.tabRouteConfig=[],this.tabRouterChanged.complete(),this.closeAll()}existInTabsIndex(t){if(this.tabSetStateArray[this.currentIndex].hasOwnProperty("histories")&&-1!==this.tabSetStateArray[this.currentIndex].histories.findIndex(e=>e===t.currentUrl))return this.currentIndex;if(this.tabSetStateArray[this.previousIndex].currentUrl===t.currentUrl)return this.previousIndex;let e=-1;return this.tabSetStateArray.length&&(e=this.tabSetStateArray.findIndex(e=>e.currentUrl===t.currentUrl)),e}checkExistsByRoute(t){if(!1===this.isStarted)return!1;const e=this.getRouteKey(t),r=this.tabSetStateArray[this.currentIndex];if(!r||!r.navigateHistory)return!1;const i=r.navigateHistory.get(e),n=this.findFirstChildComponentType(t);return!!i&&!!i.currentHandler&&i.currentHandler.has(n)}createTabRouteState(t){const e={key:this.getRouteKey(t),tabId:this.createTabId(),id:this.routerInfo.routeSnapshotProgramId(t),title:"",queryParams:t.queryParams,params:t.params,routerLink:this.getFullUrl(t),navigateHistory:new Map,currentUrl:this.getFullUrl(t),currentHandler:new Map};return this.operationInfoService.routerOperationInfo(t).pipe((0,c.first)()).subscribe(t=>{Object.assign(e,t)}),e}getTabState(t){return this.tabSetStateArray[t]}getRoutePathFromRoot(e){let r=e.pathFromRoot.map(e=>t.routeToUrl(e)).join("");return r+=e.children.map(t=>this.getChildRouteKeys(t)),r}getRoutePath(e){return e.pathFromRoot.map(e=>t.routeToUrl(e)).join("/")+"*"}getRouteKey(t){return this.getStoreKey(t)}getConfiguredUrl(t){return"/"+t.pathFromRoot.filter(t=>t.routeConfig).map(t=>t.routeConfig?t.routeConfig.path:null).join("/")}getFullUrl(t){let e=this.getUrl(t);return t._routerState&&t._routerState.url&&(e=t._routerState.url),e}getUrl(t){let e=this.getTruthRoute(t);const r=[];for(;e;)r.push(e.url.join("/")),e=e.parent;return"/"+r.filter(t=>t).reverse().join("/")}getTruthRoute(t){let e=t;for(;e.firstChild;)e=e.firstChild;return e}destroyTabRouteState(t){const{navigateHistory:e}=t;e&&e.forEach(t=>{t.currentHandler&&t.currentHandler.forEach((t,e)=>{t&&t.componentRef&&t.componentRef.destroy()})}),t.currentHandler&&t.currentHandler.size>0&&t.currentHandler.forEach(t=>{t&&t.componentRef&&t.componentRef.destroy()})}getLastNonemptyPath(t){let e=t,r="";for(;e;)e.routeConfig&&(r=e.routeConfig.path),e=e.firstChild;if(""===r){const e=t.pathFromRoot;for(let t=e.length-1;t>-1;t--)if(e[t].routeConfig&&""!==e[t].routeConfig.path){r=e[t].routeConfig.path;break}}return r}setIframeInfo(t){return(0,i.mG)(this,void 0,void 0,function*(){switch(t.type){case"fineReport":return t.item=yield this.iframeFineReportInfoService.finereportInfo(t.id,t.queryParams).pipe((0,c.first)()).toPromise();case"externalUrl":return t.item=yield this.iframeGeneralInfoService.generalInfo(t.id,t.queryParams).pipe((0,c.first)()).toPromise()}})}destroyReadyToDestroyRouteInfo(){const t=[];let e,r=0,i=this.tabSetStateArray[r];for(;i;)!0===i.canDestroy?(t.push(i),this.tabSetStateArray.splice(r,1)):r++,i=this.tabSetStateArray[r];if(t.forEach(t=>{this.destroyTabHistory(t)}),1===t.length&&t[0].opener&&(e=this.tabSetStateArray.find((r,i)=>t[0].opener===r.tabId&&(this.currentIndex=this.previousIndex=i,e=r,!0))),!e)for(let n=0;n<this.tabSetStateArray.length;n++)if(this.tabSetStateArray[n].tabId===this.currentTabInfo.tabId){this.currentIndex=this.previousIndex=n;break}this.currentIndex>=this.tabSetStateArray.length&&(this.currentIndex=this.tabSetStateArray.length-1,this.currentTabInfo=this.tabSetStateArray[this.currentIndex]),this.previousIndex>=this.tabSetStateArray.length&&(this.previousIndex=this.currentIndex,this.previousTabInfo=this.tabSetStateArray[this.previousIndex]),this.tabSetIndexChanged.next(this.currentIndex),this.readyToDestroy=!1}destroyTabHistory(t){"fineReport"===t.type||"externalUrl"===t.type||(t.navigateHistory.forEach(t=>{t.currentHandler&&(this.destroyTabRouteState(t),t.currentHandler=null)}),t.navigateHistory.clear())}createTabId(){return""+(new Date).getTime()+this.tabSetStateArray.length+Math.floor(100*Math.random())}getChildRouteKeys(e){const r=t.routeToUrl(e);return e.children.reduce((t,e)=>t+this.getChildRouteKeys(e),r)}getStoreKey(e){const r=this.getTruthRoute(e),i=t.getResolvedUrl(r),n=[];let a=r;for(;a.firstChild;)a=a.firstChild,n.push(a.url.join(""));return i+"////"+n.join("/")}createDefaultTabs(t,e,r){if(!e||!t)return;let i=-1;const n=[],a=t.filter(t=>!0===t.defaultOpen);if(r&&r.tabs.length>0)for(let s=0;s<r.tabs.length;s++){const t=r.tabs[s];let e=this.createRouteInfoFromTabConfig(t);-1===i&&this.equalCurrentUrlOrRouterLink(this.currentTabInfo,t)&&(e=Object.assign(this.currentTabInfo,e),e.lastPath=this.getLastNonemptyPath(this.currentRouteSnapshot),i=s),n.push(e)}else for(let s=0;s<a.length;s++){const t=a[s];let e=this.createRouteInfoFromTabConfig(t);!0===t.defaultOpen&&(this.isTabEqual(this.currentTabInfo,e)&&(e=Object.assign(this.currentTabInfo,e),e.currentUrl=this.getFullUrl(this.currentRouteSnapshot),e.lastPath=this.getLastNonemptyPath(this.currentRouteSnapshot),i=s),n.push(e))}if(-1===i&&n.push(this.tabSetStateArray[this.currentIndex]),this.tabSetStateArray.splice(0,this.tabSetStateArray.length,...n),r&&r.tabs.length===this.tabSetStateArray.length&&r.tabs.length===n.length){const t=r.tabs[r.currentIndex];t&&this.equalCurrentUrlOrRouterLink(t,this.currentTabInfo)&&(i=r.currentIndex),this.currentIndex=this.previousIndex=i}else this.currentIndex=this.previousIndex=this.tabSetStateArray.length>0&&i>=0?i:this.tabSetStateArray.length-1;this.currentTabInfo=this.previousTabInfo=this.tabSetStateArray[this.currentIndex],this.currentTabInfo&&this.currentTabInfo.type&&this.setIframeInfo(this.currentTabInfo),this.tabRouteConfig.length>0&&this.tabSetStateArray.forEach(t=>{if(t.id){const e=this.tabRouteConfig.find(e=>this.isTabEqual(t,e));e&&Object.assign(t,{reload:e.reload,canMultiOpen:e.canMultiOpen})}}),this.tabSetIndexChanged.next(this.currentIndex),this.defaultTabCreating=!1}equalCurrentUrlOrRouterLink(t,e){return(t.currentUrl||t.routerLink)===(e.currentUrl||t.routerLink)}createRouteInfoFromTabConfig(t){const e={};let r;t.queryParams&&(e.queryParams=t.queryParams),r=t.params?[t.routerLink,t.params]:[t.routerLink];const i=this.router.createUrlTree(r,e),n=(new o.DefaultUrlSerializer).serialize(i);return Object.assign({tabId:t.tabId||this.createTabId(),navigateHistory:new Map,currentUrl:n},t)}canMultiOpen(t){if(this.tabRouteConfig.length>0){const e=this.tabRouteConfig.find(e=>this.isTabEqual(t,e));if(e&&void 0!==e.canMultiOpen)return!!e.canMultiOpen}return!!this.TAB_MULTI_OPEN}canReload(t,e){if(this.tabRouteConfig.length>0){const e=this.tabRouteConfig.find(e=>this.isTabEqual(t,e));if(e&&e.reload)return!0===e.reload}return void 0!==e.data.reload&&!!e.data.reload}isTabEqual(t,e,r=!1){let i=!1;if(t.id&&e.id&&t.id===e.id)return i="fineReport"!==t.type&&"externalUrl"!==t.type||this.operationInfoService.isParamEqual(t.queryParams,e.queryParams),i;const n=e.currentUrl||e.routerLink;return r&&(i=this.simpleParseUrl(t.routerLink).url===this.simpleParseUrl(n).url),i}simpleParseUrl(t){const e={url:null,params:null};if(!t)return e;const r=t.indexOf("?");return e.url=-1!==r?t.substr(0,r):t,e.params=-1!==r?t.substr(r+1):"",e}initIndex(t){let e;-1===this.currentIndex&&(this.currentIndex=this.previousIndex=this.tabSetStateArray.length-1),void 0===this.tabSetStateArray[this.currentIndex]&&(e=this.createTabRouteState(t),this.tabSetStateArray[this.currentIndex]=Object.assign({},e),this.tabSetStateArray[this.currentIndex].navigateHistory.set(e.key,e))}}return t.\u0275fac=function(e){return new(e||t)(n.\u0275\u0275inject(o.Router),n.\u0275\u0275inject(a.DwAuthService),n.\u0275\u0275inject(h.DwRouterInfoService),n.\u0275\u0275inject(b),n.\u0275\u0275inject(l.DwLanguagePreService),n.\u0275\u0275inject(h.DwOperationInfoService),n.\u0275\u0275inject(d.DwIframeGeneralInfoService),n.\u0275\u0275inject(S.DwIframeFinereportInfoService),n.\u0275\u0275inject(u.DW_TAB_MULTI_OPEN),n.\u0275\u0275inject(u.APP_DEFAULT),n.\u0275\u0275inject(u.DW_OPEN_DEFAULT_WHEN_CLOSE_TABS))},t.\u0275prov=n.\u0275\u0275defineInjectable({factory:function(){return new t(n.\u0275\u0275inject(o.Router),n.\u0275\u0275inject(a.DwAuthService),n.\u0275\u0275inject(h.DwRouterInfoService),n.\u0275\u0275inject(b),n.\u0275\u0275inject(l.DwLanguagePreService),n.\u0275\u0275inject(h.DwOperationInfoService),n.\u0275\u0275inject(d.DwIframeGeneralInfoService),n.\u0275\u0275inject(S.DwIframeFinereportInfoService),n.\u0275\u0275inject(u.DW_TAB_MULTI_OPEN),n.\u0275\u0275inject(u.APP_DEFAULT),n.\u0275\u0275inject(u.DW_OPEN_DEFAULT_WHEN_CLOSE_TABS))},token:t,providedIn:"root"}),t})(),I=(()=>{class t{constructor(t,e,r,i){this.routeInfoService=t,this.programExecuteService=e,this.usingTab=r,this.router=i,this.urlSerializer=new o.DefaultUrlSerializer,this.eventSubject=new s.Subject,this.events=this.eventSubject.asObservable(),this.programExecuteService.executeTabProgram$.subscribe(t=>{this.create(t)})}get tabRouterChanged(){return this.routeInfoService.tabRouterChanged.asObservable()}create(t){let e;if(this.routeInfoService.isStarted){t&&(e=this.router.createUrlTree([t.routerLink],{queryParams:t.queryParams}));const r=this.urlSerializer.serialize(e);t.routerLink=r,this.routeInfoService.createFromRouteInfo(t),delete this.routeInfoService.getTabState(this.routeInfoService.currentIndex).opener}else t&&(e=this.router.createUrlTree([t.routerLink],{queryParams:t.queryParams}),this.router.navigateByUrl(e))}navigateOrCreate(t,e,r,i){return!0===this.usingTab&&this.routeInfoService.isStarted?this.createOrNavigate(t,e,r,i):(this.router.navigate(t,e),null)}navigateToOpenerOrCreate(t,e,r){!0===this.usingTab&&this.routeInfoService.isStarted?this.routeInfoService.navigateToOpenerFromCurrentTab(t,e,r):this.router.navigate(t,e)}createOrNavigate(t,e,r,i){let n;console.log("createOrNavigate"),n=e?this.router.createUrlTree(t,e):this.router.createUrlTree(t);const a=this.urlSerializer.serialize(n);return this.routeInfoService.createFromRouteInfo({id:null,title:i,routerLink:a},r)}close(){this.routeInfoService.closeCurrentTab()}setTitle(t){this.routeInfoService.currentTabInfo&&(this.routeInfoService.currentTabInfo.title=t)}}return t.\u0275fac=function(e){return new(e||t)(n.\u0275\u0275inject(p),n.\u0275\u0275inject(l.DwProgramExecuteService),n.\u0275\u0275inject(u.DW_USING_TAB),n.\u0275\u0275inject(o.Router))},t.\u0275prov=n.\u0275\u0275defineInjectable({factory:function(){return new t(n.\u0275\u0275inject(p),n.\u0275\u0275inject(l.DwProgramExecuteService),n.\u0275\u0275inject(u.DW_USING_TAB),n.\u0275\u0275inject(o.Router))},token:t,providedIn:"root"}),t})();class g{constructor(t,e,r,i,n){this.tabId=t,this.url=e,this.id=r,this.module=i,this.type=n}}class y extends g{}class v extends g{}class x extends g{}class T extends g{}let A=(()=>{class t{constructor(t,e,r){switch(this.strategy=t,t){case"local":this.storage=e;break;case"session":this.storage=r;break;default:this.storage=new f.BaseStorage}}clear(){this.storage.clear()}get(t){return this.storage.get(t)}getAll(){return this.storage.getAll()}remove(t){this.storage.remove(t)}set(t,e){this.storage.set(t,e)}}return t.\u0275fac=function(e){return new(e||t)(n.\u0275\u0275inject(u.DW_TAB_STORE_STRATEGY),n.\u0275\u0275inject(f.LocalStorage),n.\u0275\u0275inject(f.SessionStorage))},t.\u0275prov=n.\u0275\u0275defineInjectable({factory:function(){return new t(n.\u0275\u0275inject(u.DW_TAB_STORE_STRATEGY),n.\u0275\u0275inject(f.LocalStorage),n.\u0275\u0275inject(f.SessionStorage))},token:t,providedIn:"root"}),t})()},64762:function(t,e,r){r.d(e,{ZT:function(){return n},pi:function(){return a},_T:function(){return s},gn:function(){return o},fM:function(){return u},w6:function(){return h},mG:function(){return c},ev:function(){return l}});var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,e)};function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var a=function(){return(a=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function s(t,e){var r={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(t,i[n])&&(r[i[n]]=t[i[n]])}return r}function o(t,e,r,i){var n,a=arguments.length,s=a<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,i);else for(var o=t.length-1;o>=0;o--)(n=t[o])&&(s=(a<3?n(s):a>3?n(e,r,s):n(e,r))||s);return a>3&&s&&Object.defineProperty(e,r,s),s}function u(t,e){return function(r,i){e(r,i,t)}}function h(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function c(t,e,r,i){return new(r||(r=Promise))(function(n,a){function s(t){try{u(i.next(t))}catch(e){a(e)}}function o(t){try{u(i.throw(t))}catch(e){a(e)}}function u(t){t.done?n(t.value):function(t){return t instanceof r?t:new r(function(e){e(t)})}(t.value).then(s,o)}u((i=i.apply(t,e||[])).next())})}function l(t,e,r){if(r||2===arguments.length)for(var i,n=0,a=e.length;n<a;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return t.concat(i||Array.prototype.slice.call(e))}}}]);